<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia QR - Colegio San AgustÃ­n</title>
    <!-- SAME libraries as working example -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--cream:#fdf8f0;--white:#fff;--sand:#f0e9dc;--sand2:#e5dace;--navy:#1b2e4a;--navyL:#2d4a73;--blue:#3b6cb4;--blueS:#e8f0fb;--blueG:#d0e2f7;--green:#2a8f6a;--greenS:#dff5ec;--red:#c9463d;--redS:#fce8e6;--amber:#c68a1d;--amberS:#fdf3dc;--plum:#6b4c8a;--plumS:#f0e8f7;--txt:#2c2c2c;--txt2:#5a6472;--txt3:#8c95a3;--brd:#e4ddd3;--r:14px;--rs:10px}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Outfit',sans-serif;background:var(--cream);color:var(--txt);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--navy),var(--navyL) 60%,var(--blue));padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(27,46,74,.25)}
        .logo{display:flex;align-items:center;gap:10px}.logo-ic{width:38px;height:38px;background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px}.logo h1{font-family:'Crimson Pro',serif;font-size:18px;color:#fff}.logo small{font-size:9.5px;color:rgba(255,255,255,.5);letter-spacing:1.5px;text-transform:uppercase}
        .hdr-r{display:flex;align-items:center;gap:10px}.chip{font-size:10.5px;font-weight:600;padding:4px 10px;border-radius:20px;display:flex;align-items:center;gap:5px}.chip-g{background:rgba(255,255,255,.1);color:rgba(255,255,255,.8)}.chip-ok{background:rgba(42,143,106,.25);color:#6ee7b7}.chip-err{background:rgba(201,70,61,.25);color:#fca5a5}
        .btn-auth{padding:5px 12px;background:#fff;color:var(--navy);border:none;border-radius:7px;font-family:'Outfit';font-size:10.5px;font-weight:700;cursor:pointer}
        .nav{display:flex;gap:2px;padding:8px 24px;background:var(--white);border-bottom:1px solid var(--brd);overflow-x:auto}.nav-b{padding:8px 16px;border:none;background:0;color:var(--txt2);font-family:'Outfit';font-size:13px;font-weight:600;border-radius:var(--rs);cursor:pointer;transition:.2s;white-space:nowrap}.nav-b:hover{background:var(--sand);color:var(--txt)}.nav-b.on{background:var(--blueS);color:var(--blue)}
        .main{padding:20px 24px;max-width:900px;margin:0 auto}.pnl{display:none;animation:fi .25s}.pnl.on{display:block}@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
        .card{background:var(--white);border:1px solid var(--brd);border-radius:var(--r);padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}.card-title{font-family:'Crimson Pro',serif;font-size:16px;font-weight:700;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.form-grid .full{grid-column:1/-1}.field{display:flex;flex-direction:column;gap:3px}.field label{font-size:11px;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}.field input,.field select{padding:9px 11px;background:var(--sand);border:1.5px solid transparent;border-radius:var(--rs);color:var(--txt);font-family:'Outfit';font-size:13px;outline:0;transition:.2s}.field input:focus,.field select:focus{border-color:var(--blue);background:#fff;box-shadow:0 0 0 3px var(--blueG)}
        .photo-row{display:flex;align-items:center;gap:12px}.photo-c{width:64px;height:64px;border-radius:50%;background:var(--sand);border:2px dashed var(--brd);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0}.photo-c:hover{border-color:var(--blue)}.photo-c img{width:100%;height:100%;object-fit:cover}
        .btn{padding:9px 18px;border:none;border-radius:var(--rs);font-family:'Outfit';font-size:12px;font-weight:700;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}.btn:active{transform:scale(.97)}.btn-blue{background:var(--blue);color:#fff}.btn-blue:hover{background:var(--navyL)}.btn-ghost{background:var(--sand);color:var(--txt2)}.btn-ghost:hover{background:var(--sand2)}.btn-red{background:var(--redS);color:var(--red)}.btn-sm{padding:6px 11px;font-size:11px}
        /* QR box â€” EXACTLY like example */
        #qrcode{margin-top:14px;display:flex;justify-content:center;padding:16px;background:var(--sand);border-radius:var(--r);min-height:20px}
        #qrcode canvas,#qrcode img{display:block!important}
        .qr-actions{margin-top:10px;display:none;gap:6px;justify-content:center;flex-wrap:wrap}
        table{width:100%;border-collapse:collapse}th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--txt3);font-weight:700;border-bottom:2px solid var(--brd);background:var(--sand)}td{padding:9px 10px;font-size:13px;border-bottom:1px solid var(--brd)}tr:hover td{background:#faf7f2}
        .cn{display:flex;align-items:center;gap:8px}.av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:10px;color:#fff;overflow:hidden;flex-shrink:0}.av img{width:100%;height:100%;object-fit:cover}.tg{padding:2px 8px;border-radius:16px;font-size:10px;font-weight:700}.tg-ok{background:var(--greenS);color:var(--green)}.tg-no{background:var(--redS);color:var(--red)}
        #reader{width:100%;max-width:460px;margin:0 auto;border-radius:var(--r);overflow:hidden}
        #reader__dashboard_section_csr button{background:var(--blue)!important;color:#fff!important;border:none!important;border-radius:8px!important;padding:8px 16px!important;font-family:'Outfit'!important;font-weight:700!important;cursor:pointer!important}
        .scan-fb{padding:14px;border-radius:var(--r);text-align:center;max-width:460px;margin:10px auto 0;animation:fi .25s}.scan-fb.ok{background:var(--greenS);border:1.5px solid var(--green)}.scan-fb.warn{background:var(--amberS);border:1.5px solid var(--amber)}.scan-fb.bad{background:var(--redS);border:1.5px solid var(--red)}.scan-fb h4{font-family:'Crimson Pro',serif;font-size:15px}.scan-fb p{font-size:11.5px;color:var(--txt2)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:16px}.st{background:var(--white);border:1px solid var(--brd);border-radius:var(--r);padding:14px;border-left:4px solid}.st.sb{border-left-color:var(--blue)}.st.sg{border-left-color:var(--green)}.st.sr{border-left-color:var(--red)}.st.sa{border-left-color:var(--amber)}.st-l{font-size:10px;text-transform:uppercase;letter-spacing:.4px;color:var(--txt3);font-weight:600}.st-v{font-family:'Crimson Pro',serif;font-size:28px;font-weight:700}.st.sb .st-v{color:var(--blue)}.st.sg .st-v{color:var(--green)}.st.sr .st-v{color:var(--red)}.st.sa .st-v{color:var(--amber)}
        .lr{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--brd)}.lr:last-child{border:0}.ll{display:flex;align-items:center;gap:9px}.lt{font-size:11px;font-weight:600;color:var(--txt2);background:var(--sand);padding:3px 8px;border-radius:5px}
        .status-msg{font-size:11px;color:var(--txt3);margin-top:8px;font-style:italic}.empty{text-align:center;padding:30px 14px;color:var(--txt3)}.empty .emo{font-size:28px;margin-bottom:6px;opacity:.35}
        .toast{position:fixed;top:68px;right:14px;padding:10px 16px;border-radius:var(--rs);font-size:12px;font-weight:600;z-index:999;box-shadow:0 3px 12px rgba(0,0,0,.1);animation:ti .25s,to .25s 2.7s forwards}.toast.ok{background:var(--greenS);color:var(--green)}.toast.bad{background:var(--redS);color:var(--red)}@keyframes ti{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}@keyframes to{to{opacity:0;transform:translateX(30px)}}
        .db-b{background:var(--sand);border-radius:var(--rs);padding:10px;font-family:monospace;font-size:11px;overflow-x:auto;margin-top:5px;border:1px solid var(--brd);color:var(--txt2)}
        .overlay{display:none;position:fixed;inset:0;background:rgba(27,46,74,.4);backdrop-filter:blur(4px);z-index:500;align-items:center;justify-content:center}.overlay.open{display:flex}
        .modal{background:var(--white);border-radius:16px;padding:28px;text-align:center;max-width:400px;width:90%;box-shadow:0 8px 30px rgba(0,0,0,.12);animation:mp .2s}@keyframes mp{from{transform:scale(.94);opacity:0}to{transform:scale(1);opacity:1}}
        .modal h3{font-family:'Crimson Pro',serif;font-size:18px;margin-bottom:2px}.modal .sub{color:var(--txt2);font-size:12px;margin-bottom:14px}.modal .qr-wrap{display:inline-block;padding:10px;background:#fff;border:2px solid var(--brd);border-radius:var(--r);margin-bottom:14px}.modal .qr-wrap canvas,.modal .qr-wrap img{display:block!important}.modal-btns{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
        @media(max-width:640px){.header{padding:0 14px;height:52px}.nav{padding:6px 10px}.main{padding:14px}.form-grid{grid-template-columns:1fr}.stats{grid-template-columns:1fr 1fr}}
    </style>
</head>
<body>
<header class="header">
    <div class="logo"><div class="logo-ic">ğŸ“</div><div><h1>San AgustÃ­n</h1><small>Asistencia Escolar</small></div></div>
    <div class="hdr-r">
        <div class="chip chip-g" id="syncC">â³ Cargando...</div>
        <button class="btn-auth" id="authB" onclick="handleAuth()" style="display:none">ğŸ”‘ Conectar Google</button>
        <button class="btn-auth" id="outB" onclick="handleSignout()" style="display:none">Cerrar sesiÃ³n</button>
    </div>
</header>
<nav class="nav" id="navBar">
    <button class="nav-b on" data-p="register">ğŸ“ Registrar</button>
    <button class="nav-b" data-p="scanner">ğŸ“· Escanear</button>
    <button class="nav-b" data-p="students">ğŸ‘¥ Alumnos</button>
    <button class="nav-b" data-p="attendance">ğŸ“Š Asistencia</button>
</nav>
<main class="main">

<!-- REGISTER -->
<section id="p-register" class="pnl on">
    <div class="card">
        <div class="card-title">ğŸ“‹ Registrar Nuevo Estudiante</div>
        <form id="regForm" onsubmit="doRegister(event)">
            <div class="form-grid">
                <div class="field full"><label>Foto</label><div class="photo-row"><div class="photo-c" id="phC" onclick="document.getElementById('phF').click()"><span style="font-size:20px;opacity:.3">ğŸ“·</span></div><input type="file" id="phF" accept="image/*" style="display:none" onchange="loadPhoto(this)"><button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('phF').click()">Elegir</button></div></div>
                <div class="field"><label>Nombre *</label><input type="text" id="iN" placeholder="MarÃ­a GarcÃ­a LÃ³pez" required></div>
                <div class="field"><label>DNI *</label><input type="text" id="iD" placeholder="72345678" required></div>
                <div class="field"><label>Grado *</label><select id="iG" required><option value="">...</option><option>1Â° Primaria</option><option>2Â° Primaria</option><option>3Â° Primaria</option><option>4Â° Primaria</option><option>5Â° Primaria</option><option>6Â° Primaria</option><option>1Â° Secundaria</option><option>2Â° Secundaria</option><option>3Â° Secundaria</option><option>4Â° Secundaria</option><option>5Â° Secundaria</option></select></div>
                <div class="field"><label>SecciÃ³n *</label><select id="iS" required><option value="">...</option><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                <div class="field full" style="margin-top:4px"><button type="submit" class="btn btn-blue">ğŸ“± Registrar y Generar QR</button></div>
            </div>
        </form>
        <!-- QR VISIBLE HERE â€” exactly like the example file -->
        <div id="qrcode"></div>
        <p id="qrStatus" class="status-msg"></p>
        <div class="qr-actions" id="qrActions">
            <button class="btn btn-blue btn-sm" onclick="dlPDF()">ğŸ“„ Carnet PDF</button>
            <button class="btn btn-ghost btn-sm" onclick="dlQRpng()">ğŸ–¼ï¸ Descargar QR</button>
        </div>
    </div>
    <div class="card"><div class="card-title">ğŸ• Ãšltimos Registros</div><div id="recList"><div class="empty"><div class="emo">ğŸ‘¤</div><p>Sin registros</p></div></div></div>
</section>

<!-- SCANNER -->
<section id="p-scanner" class="pnl">
    <div class="card">
        <div class="card-title">ğŸ“· EscÃ¡ner de Asistencia</div>
        <div style="display:flex;gap:12px;justify-content:center;margin-bottom:10px">
            <label style="display:flex;align-items:center;gap:4px;font-weight:600;font-size:13px;cursor:pointer"><input type="radio" name="scanMode" value="ENTRADA" checked> ğŸŸ¢ Entrada</label>
            <label style="display:flex;align-items:center;gap:4px;font-weight:600;font-size:13px;cursor:pointer"><input type="radio" name="scanMode" value="SALIDA"> ğŸ”´ Salida</label>
        </div>
        <div id="reader"></div>
        <div id="scanFb"></div>
    </div>
    <div class="card"><div class="card-title">ğŸ“‹ Hoy</div><div id="todLog"><div class="empty"><div class="emo">ğŸ“±</div><p>Escanea un QR</p></div></div></div>
</section>

<!-- STUDENTS -->
<section id="p-students" class="pnl">
    <input type="text" id="sBox" placeholder="ğŸ” Buscar..." oninput="rStudents()" style="width:100%;padding:10px 14px;background:var(--white);border:1.5px solid var(--brd);border-radius:var(--rs);font-family:'Outfit';font-size:13px;outline:0;margin-bottom:12px">
    <div class="card"><div class="card-title">ğŸ‘¥ Estudiantes</div><div style="overflow-x:auto"><table><thead><tr><th>Estudiante</th><th>DNI</th><th>Grado</th><th>Hoy</th><th>Acciones</th></tr></thead><tbody id="tB"></tbody></table></div><div id="tE" class="empty" style="display:none"><div class="emo">ğŸ“‹</div><p>Sin estudiantes</p></div></div>
</section>

<!-- ATTENDANCE -->
<section id="p-attendance" class="pnl">
    <div class="stats"><div class="st sb"><div class="st-l">Total</div><div class="st-v" id="xT">0</div></div><div class="st sg"><div class="st-l">Presentes</div><div class="st-v" id="xP">0</div></div><div class="st sr"><div class="st-l">Ausentes</div><div class="st-v" id="xA">0</div></div><div class="st sa"><div class="st-l">%</div><div class="st-v" id="xPc">0%</div></div></div>
    <div class="card"><div class="card-title">ğŸ“Š Historial</div><div id="attH"><div class="empty"><div class="emo">ğŸ“…</div><p>Sin registros</p></div></div></div>
    <div class="card"><div class="card-title">ğŸ—„ï¸ Estructura Sheets</div><p style="font-size:12px;color:var(--txt2)"><b>Estudiantes</b>:</p><div class="db-b">id | nombre | dni | grado | seccion | foto_drive | qr_drive | fecha</div><p style="font-size:12px;color:var(--txt2);margin-top:8px"><b>Asistencia</b>:</p><div class="db-b">id_estudiante | nombre | dni | grado | seccion | fecha | hora | tipo</div></div>
</section>
</main>

<!-- Modal -->
<div class="overlay" id="ovl"><div class="modal"><h3 id="mN"></h3><p class="sub" id="mI"></p><div class="qr-wrap" id="mQR"></div><div class="modal-btns"><button class="btn btn-blue btn-sm" onclick="dlPDFm()">ğŸ“„ PDF</button><button class="btn btn-ghost btn-sm" onclick="dlQRm()">ğŸ–¼ï¸ QR</button><button class="btn btn-red btn-sm" onclick="document.getElementById('ovl').classList.remove('open')">Cerrar</button></div></div></div>

<script>
// â•â•â• CONFIG â•â•â•
const CLIENT_ID='814005655098-8csk41qts3okv4b2fjnq7ls4qc2kq0vc.apps.googleusercontent.com';
const API_KEY='AIzaSyAOhGTjJXHhuUhqf1g2DPCla59xNzftb-Q';
const SHEET_ID='1m0rv2gcMW3E8Yrh02PnwtHgZ3utj8XRPa9kYpwwm5oo';
const FOLDER='1ig8n3pthz8esYzmAsoibPUPz1MNVg88m';
const SCOPES='https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
let tokenClient,gapiOk=false,gisOk=false,authed=false;

// â•â•â• GOOGLE AUTH â•â•â•
function onGapiLoad(){gapi.load('client',async()=>{await gapi.client.init({apiKey:API_KEY,discoveryDocs:['https://sheets.googleapis.com/$discovery/rest?version=v4','https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});gapiOk=true;tryR()})}
function onGisLoad(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:''});gisOk=true;tryR()}
function tryR(){if(gapiOk&&gisOk){document.getElementById('authB').style.display='inline-flex';loadSheets()}}
function handleAuth(){tokenClient.callback=async r=>{if(r.error){sync('err','âœ— Error');return}authed=true;document.getElementById('authB').style.display='none';document.getElementById('outB').style.display='inline-flex';sync('ok','âœ“ Conectado');await loadSheets()};gapi.client.getToken()===null?tokenClient.requestAccessToken({prompt:'consent'}):tokenClient.requestAccessToken({prompt:''})}
function handleSignout(){const t=gapi.client.getToken();if(t){google.accounts.oauth2.revoke(t.access_token);gapi.client.setToken('')}authed=false;document.getElementById('authB').style.display='inline-flex';document.getElementById('outB').style.display='none';sync('g','Desconectado')}
function sync(t,x){const e=document.getElementById('syncC');e.className='chip '+(t==='ok'?'chip-ok':t==='err'?'chip-err':'chip-g');e.textContent=x}

// â•â•â• SHEETS â•â•â•
async function shR(range){try{return(await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:SHEET_ID,range})).result.values||[]}catch(e){return null}}
async function shA(sheet,v){try{await gapi.client.sheets.spreadsheets.values.append({spreadsheetId:SHEET_ID,range:sheet,valueInputOption:'USER_ENTERED',insertDataOption:'INSERT_ROWS',resource:{values:[v]}});return true}catch(e){return false}}
async function loadSheets(){
    sync('g','â³ Cargando...');
    const sd=await shR('Estudiantes!A2:H');
    if(!sd){sync('err','âœ— Error');const s=localStorage.getItem('sch6');if(s)db=JSON.parse(s);refreshAll();return}
    db.students=sd.map(r=>({id:r[0]||'',name:r[1]||'',dni:r[2]||'',grade:r[3]||'',section:r[4]||'',photoUrl:r[5]||'',qrUrl:r[6]||'',createdAt:r[7]||''}));
    const ad=await shR('Asistencia!A2:H');
    if(ad)db.attendance=ad.map(r=>({sid:r[0]||'',name:r[1]||'',dni:r[2]||'',grade:r[3]||'',section:r[4]||'',date:r[5]||'',time:r[6]||'',type:r[7]||'ENTRADA'}));
    saveL();sync('ok','âœ“ Sincronizado');refreshAll()}

// â•â•â• DRIVE â•â•â•
async function upDrive(fname,b64,mime){
    if(!authed)return null;
    try{const b=atob(b64.split(',')[1]);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);
    const blob=new Blob([a],{type:mime});const meta={name:fname,mimeType:mime,parents:[FOLDER]};
    const tk=gapi.client.getToken().access_token;const fd=new FormData();
    fd.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));fd.append('file',blob);
    const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',headers:{Authorization:'Bearer '+tk},body:fd});
    const d=await r.json();
    if(d.id){await fetch(`https://www.googleapis.com/drive/v3/files/${d.id}/permissions`,{method:'POST',headers:{Authorization:'Bearer '+tk,'Content-Type':'application/json'},body:JSON.stringify({role:'reader',type:'anyone'})});return`https://drive.google.com/file/d/${d.id}/view`}
    }catch(e){console.warn(e)}return null}

// â•â•â• DATA â•â•â•
let db={students:[],attendance:[]},curPh=null,lastSt=null;
function saveL(){localStorage.setItem('sch6',JSON.stringify(db))}
const today=()=>new Date().toISOString().split('T')[0];
const timeN=()=>new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
const uid=()=>Date.now().toString(36)+Math.random().toString(36).substr(2,6);
const PAL=['#3b6cb4','#2a8f6a','#c68a1d','#6b4c8a','#c9463d','#0891b2','#be185d','#4f46e5','#ea580c','#0d9488'];
const pick=s=>{let h=0;for(let c of s)h=c.charCodeAt(0)+((h<<5)-h);return PAL[Math.abs(h)%PAL.length]};
const ini=n=>n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
function avH(s,z=30){if(s.photo&&s.photo.startsWith('data:'))return`<div class="av" style="width:${z}px;height:${z}px"><img src="${s.photo}"></div>`;return`<div class="av" style="width:${z}px;height:${z}px;background:${pick(s.name||'?')};font-size:${z*.34}px">${ini(s.name||'?')}</div>`}
function toast(m,ok=true){const t=document.createElement('div');t.className=`toast ${ok?'ok':'bad'}`;t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}

// â•â•â• NAV â•â•â•
let qrSc=null,scOn=false;
document.getElementById('navBar').addEventListener('click',e=>{const b=e.target.closest('.nav-b');if(!b)return;document.querySelectorAll('.pnl').forEach(s=>s.classList.remove('on'));document.querySelectorAll('.nav-b').forEach(x=>x.classList.remove('on'));document.getElementById('p-'+b.dataset.p).classList.add('on');b.classList.add('on');if(b.dataset.p==='scanner')initScan();else stopScan();if(b.dataset.p==='students')rStudents();if(b.dataset.p==='attendance')rAtt()});

// â•â•â• PHOTO â•â•â•
function loadPhoto(inp){const f=inp.files[0];if(!f)return;const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const c=document.createElement('canvas'),M=200;let w=img.width,h=img.height;if(w>h){h=(h/w)*M;w=M}else{w=(w/h)*M;h=M}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);curPh=c.toDataURL('image/jpeg',.75);document.getElementById('phC').innerHTML=`<img src="${curPh}">`};img.src=e.target.result};rd.readAsDataURL(f)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGISTER â€” QR on page like example
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister(e){
    e.preventDefault();
    const name=document.getElementById('iN').value.trim(),dni=document.getElementById('iD').value.trim(),grade=document.getElementById('iG').value,section=document.getElementById('iS').value;
    if(db.students.find(s=>s.dni===dni)){toast('Ya existe ese DNI',false);return}
    const id=uid();
    const student={id,name,dni,grade,section,photo:curPh||'',photoUrl:'',qrUrl:'',createdAt:new Date().toISOString()};

    // â”€â”€ Generate QR EXACTLY like example â”€â”€
    const el=document.getElementById("qrcode");
    el.innerHTML=""; // Clear â€” same as example
    const qrData=JSON.stringify({id,name,dni,grade,section});
    new QRCode(el,{text:qrData,width:180,height:180,colorDark:'#1b2e4a',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});
    // â”€â”€ QR is now VISIBLE on page â”€â”€

    document.getElementById('qrActions').style.display='flex';
    lastSt=student;
    const status=document.getElementById('qrStatus');

    await new Promise(r=>setTimeout(r,500)); // Wait for canvas

    if(authed){
        const safe=name.replace(/[^a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘0-9\s]/g,'').replace(/\s+/g,'_');
        if(curPh){status.textContent='ğŸ“¤ Subiendo foto...';const pl=await upDrive(`Foto_${safe}.jpg`,curPh,'image/jpeg');if(pl)student.photoUrl=pl}
        const qc=el.querySelector('canvas');
        if(qc){status.textContent='ğŸ“¤ Subiendo QR...';const ql=await upDrive(`QR_${safe}.png`,qc.toDataURL('image/png'),'image/png');if(ql)student.qrUrl=ql}
        status.textContent='ğŸ“¤ Guardando en Sheets...';
        await shA('Estudiantes',[student.id,student.name,student.dni,student.grade,student.section,student.photoUrl,student.qrUrl,student.createdAt]);
        status.textContent='âœ… Registrado y sincronizado con Google';
    }else{status.textContent='ğŸ’¾ Solo local (conecta Google para sincronizar)'}

    db.students.push(student);saveL();
    document.getElementById('regForm').reset();document.getElementById('phC').innerHTML='<span style="font-size:20px;opacity:.3">ğŸ“·</span>';curPh=null;
    rRecent();toast('âœ“ Estudiante registrado');
}

// â•â•â• DOWNLOADS (register page) â•â•â•
function dlQRpng(){if(!lastSt)return;const c=document.querySelector('#qrcode canvas'),i=document.querySelector('#qrcode img'),s=c?c.toDataURL('image/png'):(i?i.src:null);if(!s)return;const a=document.createElement('a');a.href=s;a.download=`QR_${lastSt.name.replace(/\s/g,'_')}.png`;a.click()}
function dlPDF(){if(lastSt)mkPDF(lastSt,'#qrcode')}

// â•â•â• MODAL (existing students) â•â•â•
function openQR(id){const s=db.students.find(x=>x.id===id);if(!s)return;lastSt=s;document.getElementById('mN').textContent=s.name;document.getElementById('mI').textContent=`${s.grade} "${s.section}" â€” ${s.dni}`;const b=document.getElementById('mQR');b.innerHTML='';new QRCode(b,{text:JSON.stringify({id:s.id,name:s.name,dni:s.dni,grade:s.grade,section:s.section}),width:180,height:180,colorDark:'#1b2e4a',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});document.getElementById('ovl').classList.add('open')}
function dlQRm(){const c=document.querySelector('#mQR canvas'),i=document.querySelector('#mQR img'),s=c?c.toDataURL('image/png'):(i?i.src:null);if(!s||!lastSt)return;const a=document.createElement('a');a.href=s;a.download=`QR_${lastSt.name.replace(/\s/g,'_')}.png`;a.click()}
function dlPDFm(){if(lastSt)mkPDF(lastSt,'#mQR')}

// â•â•â• PDF CARNET â•â•â•
function mkPDF(s,sel){
    const{jsPDF}=window.jspdf,pdf=new jsPDF({orientation:'landscape',unit:'mm',format:[92,58]});
    pdf.setFillColor(27,46,74);pdf.rect(0,0,92,21,'F');pdf.setFillColor(253,248,240);pdf.rect(0,21,92,37,'F');pdf.setFillColor(59,108,180);pdf.rect(0,21,92,1.5,'F');
    pdf.setFont('helvetica','bold');pdf.setFontSize(9.5);pdf.setTextColor(255,255,255);pdf.text('COLEGIO SAN AGUSTÃN',46,8,{align:'center'});
    pdf.setFont('helvetica','normal');pdf.setFontSize(5.5);pdf.setTextColor(160,185,220);pdf.text('CARNET ESTUDIANTIL',46,12.5,{align:'center'});pdf.text('AÃ‘O '+new Date().getFullYear(),46,16,{align:'center'});
    if(s.photo&&s.photo.startsWith('data:')){try{pdf.addImage(s.photo,'JPEG',5,25,17,17)}catch(e){dI()}}else{dI()}
    function dI(){pdf.setFillColor(59,108,180);pdf.rect(5,25,17,17,'F');pdf.setFont('helvetica','bold');pdf.setFontSize(11);pdf.setTextColor(255,255,255);pdf.text(ini(s.name),13.5,35.5,{align:'center'})}
    pdf.setDrawColor(59,108,180);pdf.setLineWidth(.4);pdf.rect(5,25,17,17);
    pdf.setTextColor(27,46,74);pdf.setFont('helvetica','bold');pdf.setFontSize(7.5);pdf.text(s.name.toUpperCase(),25,29);
    pdf.setFont('helvetica','normal');pdf.setFontSize(5.8);pdf.setTextColor(90,100,114);pdf.text('DNI: '+s.dni,25,34);pdf.text('Grado: '+s.grade,25,38);pdf.text('SecciÃ³n: '+s.section,25,42);
    const qc=document.querySelector(sel+' canvas'),qi=document.querySelector(sel+' img'),qs=qc?qc.toDataURL('image/png'):(qi?qi.src:null);
    if(qs){pdf.addImage(qs,'PNG',67,24,20,20);pdf.setDrawColor(200,210,220);pdf.setLineWidth(.25);pdf.rect(67,24,20,20)}
    pdf.setFontSize(4.2);pdf.setTextColor(140,149,163);pdf.text('Carnet personal e intransferible',46,49,{align:'center'});pdf.setFillColor(59,108,180);pdf.rect(0,56.5,92,1.5,'F');
    pdf.save(`Carnet_${s.name.replace(/\s/g,'_')}.pdf`);toast('âœ“ PDF descargado');
}

// â•â•â• SCANNER â•â•â•
function initScan(){if(qrSc)return;qrSc=new Html5QrcodeScanner("reader",{fps:10,qrbox:{width:250,height:250},rememberLastUsedCamera:true,supportedScanTypes:[Html5QrcodeScanType.SCAN_TYPE_CAMERA]},false);qrSc.render(onScan,()=>{});scOn=true}
function stopScan(){if(qrSc&&scOn){try{qrSc.clear()}catch(e){}qrSc=null;scOn=false}}
let lastSc=0;
async function onScan(dec){if(Date.now()-lastSc<3500)return;lastSc=Date.now();const mode=document.querySelector('input[name="scanMode"]:checked').value;let d;try{d=JSON.parse(dec)}catch{sfb('bad','QR no vÃ¡lido','No es del sistema');return}const st=db.students.find(s=>s.id===d.id);if(!st){sfb('bad','No encontrado','QR no registrado');return}const dup=db.attendance.find(a=>a.sid===st.id&&a.date===today()&&a.type===mode);if(dup){sfb('warn',st.name,`Ya tiene ${mode} (${dup.time})`);return}const t=timeN();const rec={sid:st.id,name:st.name,dni:st.dni,grade:st.grade,section:st.section,date:today(),time:t,type:mode};db.attendance.push(rec);saveL();if(authed)await shA('Asistencia',[rec.sid,rec.name,rec.dni,rec.grade,rec.section,rec.date,rec.time,rec.type]);sfb('ok',`âœ“ ${st.name}`,`${mode} â€” ${t}`);rTodLog();try{const ax=new(window.AudioContext||window.webkitAudioContext)();const o=ax.createOscillator();const g=ax.createGain();o.connect(g);g.connect(ax.destination);o.frequency.value=800;g.gain.value=.1;o.start();setTimeout(()=>o.frequency.value=1200,80);setTimeout(()=>{o.stop();ax.close()},180)}catch(e){}}
function sfb(t,ti,ms){document.getElementById('scanFb').innerHTML=`<div class="scan-fb ${t}"><h4>${ti}</h4><p>${ms}</p></div>`;setTimeout(()=>document.getElementById('scanFb').innerHTML='',4000)}

// â•â•â• RENDERS â•â•â•
function rRecent(){const el=document.getElementById('recList'),r=[...db.students].reverse().slice(0,5);if(!r.length){el.innerHTML='<div class="empty"><div class="emo">ğŸ‘¤</div><p>Sin registros</p></div>';return}el.innerHTML=r.map(s=>`<div class="lr"><div class="ll">${avH(s)}<div><b style="font-size:13px">${s.name}</b><div style="font-size:11px;color:var(--txt2)">${s.grade} "${s.section}" â€” ${s.dni}</div></div></div><div style="display:flex;gap:4px"><button class="btn btn-blue btn-sm" onclick='openQR("${s.id}")'>ğŸ“±</button><button class="btn btn-red btn-sm" onclick='delSt("${s.id}")'>âœ•</button></div></div>`).join('')}
function rStudents(){const tb=document.getElementById('tB'),emp=document.getElementById('tE'),q=(document.getElementById('sBox')?.value||'').toLowerCase();let ls=db.students;if(q)ls=ls.filter(s=>s.name.toLowerCase().includes(q)||s.dni.includes(q));if(!ls.length){tb.innerHTML='';emp.style.display='block';return}emp.style.display='none';tb.innerHTML=ls.map(s=>{const a=db.attendance.find(x=>x.sid===s.id&&x.date===today()&&x.type==='ENTRADA');return`<tr><td><div class="cn">${avH(s)} ${s.name}</div></td><td>${s.dni}</td><td>${s.grade} ${s.section}</td><td>${a?'<span class="tg tg-ok">âœ“</span>':'<span class="tg tg-no">âœ—</span>'}</td><td><div style="display:flex;gap:4px"><button class="btn btn-blue btn-sm" onclick='openQR("${s.id}")'>ğŸ“±</button><button class="btn btn-red btn-sm" onclick='delSt("${s.id}")'>âœ•</button></div></td></tr>`}).join('')}
function rTodLog(){const el=document.getElementById('todLog'),recs=db.attendance.filter(a=>a.date===today()).reverse();if(!recs.length){el.innerHTML='<div class="empty"><div class="emo">ğŸ“±</div><p>Escanea un QR</p></div>';return}el.innerHTML=recs.map(a=>{const s=db.students.find(x=>x.id===a.sid)||{name:a.name,photo:''};const cl=a.type==='ENTRADA'?'var(--green)':'var(--red)';return`<div class="lr"><div class="ll">${avH(s,26)}<b style="font-size:12px">${a.name}</b><span style="font-size:10px;color:${cl};font-weight:700">${a.type}</span></div><div class="lt">${a.time}</div></div>`}).join('')}
function rAtt(){const t=db.students.length,p=db.attendance.filter(a=>a.date===today()&&a.type==='ENTRADA').length;document.getElementById('xT').textContent=t;document.getElementById('xP').textContent=p;document.getElementById('xA').textContent=t-p;document.getElementById('xPc').textContent=t?Math.round(p/t*100)+'%':'0%';const el=document.getElementById('attH'),ds=[...new Set(db.attendance.map(a=>a.date))].sort().reverse();if(!ds.length){el.innerHTML='<div class="empty"><div class="emo">ğŸ“…</div><p>Sin registros</p></div>';return}el.innerHTML=ds.map(dt=>{const recs=db.attendance.filter(a=>a.date===dt);const fmt=new Date(dt+'T12:00:00').toLocaleDateString('es',{weekday:'long',day:'numeric',month:'long'});return`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><b style="text-transform:capitalize;font-size:13px">${fmt}</b><span class="tg tg-ok">${recs.filter(r=>r.type==='ENTRADA').length}</span></div>${recs.map(a=>{const cl=a.type==='ENTRADA'?'var(--green)':'var(--red)';return`<div class="lr" style="padding:5px 0"><div class="ll"><span style="font-size:12px">${a.name}</span><span style="font-size:9px;color:${cl};font-weight:700">${a.type}</span></div><div class="lt">${a.time}</div></div>`}).join('')}</div>`}).join('')}
function refreshAll(){rRecent();rTodLog()}
function delSt(id){if(!confirm('Â¿Eliminar?'))return;db.students=db.students.filter(s=>s.id!==id);db.attendance=db.attendance.filter(a=>a.sid!==id);saveL();refreshAll();rStudents();toast('Eliminado')}

// INIT
(function(){const s=localStorage.getItem('sch6');if(s)db=JSON.parse(s);refreshAll()})();
</script>
</body>
</html>
