<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1b2e4a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema de Asistencia QR â€” Instituto CEAN</title>

    <!-- LibrerÃ­as externas -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>

    <!-- TipografÃ­as -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos propios -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ENCABEZADO
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ“</div>
            <div>
                <h1>Instituto CEAN</h1>
                <small>Asistencia</small>
            </div>
        </div>
        <div class="header-right">
            <div class="chip chip-g" id="syncChip">â³ Cargando...</div>
            <button class="btn-auth" id="authBtn"   onclick="handleAuth()"    style="display:none">ğŸ”‘ Conectar Google</button>
            <button class="btn-auth" id="logoutBtn" onclick="handleSignout()" style="display:none">Cerrar sesiÃ³n</button>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         NAVEGACIÃ“N
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <nav class="nav" id="navBar">
        <button class="nav-btn active" data-panel="register" >ğŸ“ Registrar</button>
        <button class="nav-btn"        data-panel="scanner"  >ğŸ“· Escanear</button>
        <button class="nav-btn"        data-panel="students" >ğŸ‘¥ Alumnos</button>
        <button class="nav-btn"        data-panel="attendance">ğŸ“Š Asistencia</button>
        <button class="nav-btn"        data-panel="reports"  >ğŸ“‹ Reportes</button>
    </nav>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CONTENIDO PRINCIPAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="main">

        <!-- â”€â”€â”€ PANEL: REGISTRAR â”€â”€â”€ -->
        <section id="panel-register" class="panel active">
            <div class="card">
                <div class="card-title">ğŸ“‹ Registrar Nuevo Alumno</div>
                <form id="regForm" onsubmit="doRegister(event)">
                    <div class="form-grid">
                        <div class="field full">
                            <label>Foto del alumno</label>
                            <div class="photo-row">
                                <div class="photo-circle" id="photoCircle"
                                     onclick="document.getElementById('photoFile').click()">ğŸ“·</div>
                                <input type="file" id="photoFile" accept="image/*"
                                       style="display:none" onchange="loadPhoto(this)">
                                <small style="color:var(--txt3)">Toca para agregar foto (opcional)</small>
                            </div>
                        </div>

                        <div class="field">
                            <label>Nombre completo *</label>
                            <input type="text" id="inputName" required placeholder="Ej: Juan PÃ©rez LÃ³pez">
                        </div>
                        <div class="field">
                            <label>Carnet de Identidad *</label>
                            <input type="text" id="inputDni" required placeholder="Ej: 12345678">
                        </div>
                        <div class="field">
                            <label>Curso *</label>
                            <select id="inputGrade" required>
                                <option value="">Cargando cursos...</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Paralelo *</label>
                            <select id="inputSection" required>
                                <option value="">Seleccionar...</option>
                                <option>A</option>
                                <option>B</option>
                                <option>C</option>
                            </select>
                        </div>

                        <div class="field full">
                            <button type="submit" class="btn btn-blue btn-block">
                                ğŸ“± Registrar y Generar CÃ³digo QR
                            </button>
                        </div>
                    </div>
                </form>

                <div class="qr-container" id="qrcode"></div>
                <p class="qr-status" id="qrStatus"></p>
                <div class="qr-actions" id="qrActions">
                    <button class="btn btn-blue btn-sm"  onclick="downloadPDF()">ğŸ“„ Descargar Carnet PDF</button>
                    <button class="btn btn-ghost btn-sm" onclick="downloadQRPng()">ğŸ–¼ï¸ Descargar QR</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ• Ãšltimos Registros</div>
                <div id="recentList"></div>
            </div>
        </section>

        <!-- â”€â”€â”€ PANEL: ESCÃNER â”€â”€â”€ -->
        <section id="panel-scanner" class="panel">
            <div class="card">
                <div class="card-title">ğŸ“· EscÃ¡ner de Asistencia</div>

                <!-- Selector Entrada / Salida -->
                <div class="scan-mode-selector">
                    <label class="mode-entrada">
                        <input type="radio" name="scanMode" value="ENTRADA" checked>
                        ğŸŸ¢ Entrada
                    </label>
                    <label class="mode-salida">
                        <input type="radio" name="scanMode" value="SALIDA">
                        ğŸ”´ Salida
                    </label>
                </div>

                <!-- Vista del escÃ¡ner (botones en inglÃ©s se reemplazan vÃ­a CSS + MutationObserver en app.js) -->
                <div class="scanner-wrapper">
                    <div id="reader"></div>
                </div>

                <!-- RetroalimentaciÃ³n -->
                <div id="scanFeedback"></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“‹ Registros de Hoy</div>
                <div id="todayLog"></div>
            </div>
        </section>

        <!-- â”€â”€â”€ PANEL: ALUMNOS â”€â”€â”€ -->
        <section id="panel-students" class="panel">
            <input type="text" id="searchBox" class="search-box"
                   placeholder="ğŸ” Buscar alumno por nombre o DNI..."
                   oninput="renderStudentsTable()">
            <div class="card">
                <div class="card-title">ğŸ‘¥ Lista de Alumnos</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Carnet</th>
                                <th>Estado Hoy</th>
                                <th>QR</th>
                            </tr>
                        </thead>
                        <tbody id="studentsBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- â”€â”€â”€ PANEL: ASISTENCIA â”€â”€â”€ -->
        <section id="panel-attendance" class="panel">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-label">Total Estudiantes</div>
                    <div class="stat-value" id="statTotal">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Presentes Hoy</div>
                    <div class="stat-value" id="statPresent">0</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Ausentes Hoy</div>
                    <div class="stat-value" id="statAbsent">0</div>
                </div>
                <div class="stat-card amber">
                    <div class="stat-label">Salidas Registradas</div>
                    <div class="stat-value" id="statExits">0</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“Š Resumen del DÃ­a</div>
                <div id="todayLog2"></div>
            </div>
        </section>

        <!-- â”€â”€â”€ PANEL: REPORTES â”€â”€â”€ -->
        <section id="panel-reports" class="panel">
            <div class="card">
                <div class="card-title">ğŸ“‹ Generar Reporte de Asistencia</div>
                <div class="report-filters">
                    <div class="field">
                        <label>Fecha Desde</label>
                        <input type="date" id="reportDateFrom" onchange="renderReports()">
                    </div>
                    <div class="field">
                        <label>Fecha Hasta</label>
                        <input type="date" id="reportDateTo" onchange="renderReports()">
                    </div>
                    <div class="field">
                        <label>Curso</label>
                        <select id="reportGrade" onchange="renderReports()">
                            <option value="">Todos los cursos</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Paralelo</label>
                        <select id="reportSection" onchange="renderReports()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="field" style="justify-content:flex-end">
                        <label>&nbsp;</label>
                        <button class="btn btn-green btn-sm" onclick="downloadReport()">
                            ğŸ“„ Descargar PDF
                        </button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom:14px">
                    <div class="stat-card blue" ><div class="stat-label">Total</div>    <div class="stat-value" id="reportTotal">0</div></div>
                    <div class="stat-card green"><div class="stat-label">Presentes</div><div class="stat-value" id="reportPresent">0</div></div>
                    <div class="stat-card red"  ><div class="stat-label">Ausentes</div> <div class="stat-value" id="reportAbsent">0</div></div>
                    <div class="stat-card amber"><div class="stat-label">Salidas</div>  <div class="stat-value" id="reportExits">0</div></div>
                </div>

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Curso</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Entrada</th>
                                <th>Salida</th>
                            </tr>
                        </thead>
                        <tbody id="reportBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ• Horarios del DÃ­a</div>
                <div id="scheduleToday"></div>
            </div>
        </section>

    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TOASTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODAL QR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="overlay" id="overlay" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <h3 id="modalName"></h3>
            <p class="modal-sub" id="modalInfo"></p>
            <div class="qr-wrap" id="modalQR"></div>
            <div class="modal-btns">
                <button class="btn btn-blue btn-sm" onclick="downloadPDFFromModal()">ğŸ“„ Carnet PDF</button>
                <button class="btn btn-red  btn-sm" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         NOTIFICACIÃ“N EMERGENTE DE ESCANEO
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="scanNotification" class="scan-notification" onclick="this.classList.remove('visible')">
        <div class="scan-notif-inner">
            <div class="scan-notif-icon" id="scanNotifIcon">âœ…</div>
            <div class="scan-notif-name" id="scanNotifName">Nombre del Estudiante</div>
            <div class="scan-notif-detail" id="scanNotifDetail">Entrada registrada Â· 08:00</div>
            <div class="scan-notif-course" id="scanNotifCourse">Curso A</div>
            <div class="scan-notif-hint">Toca para cerrar</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SCRIPTS PROPIOS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script src="config.js"></script>
    <script src="app.js"></script>

</body>
</html>
