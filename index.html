<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia Escolar - QR</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Generator (same as working example) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <style>
        :root {
            --cream: #fdf8f0;
            --warm-white: #ffffff;
            --sand: #f3ece0;
            --sand-dark: #e8ddd0;
            --navy: #1b2e4a;
            --navy-light: #2d4a73;
            --blue: #3b6cb4;
            --blue-soft: #e8f0fb;
            --blue-glow: #d0e2f7;
            --emerald: #2a8f6a;
            --emerald-soft: #dff5ec;
            --coral: #c9463d;
            --coral-soft: #fce8e6;
            --amber: #c68a1d;
            --amber-soft: #fdf3dc;
            --plum: #6b4c8a;
            --plum-soft: #f0e8f7;
            --text: #2c2c2c;
            --text-mid: #5a6472;
            --text-light: #8c95a3;
            --border: #e4ddd3;
            --shadow-sm: 0 1px 3px rgba(27,46,74,0.06);
            --shadow-md: 0 4px 16px rgba(27,46,74,0.08);
            --shadow-lg: 0 8px 32px rgba(27,46,74,0.12);
            --radius: 14px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--cream);
            color: var(--text);
            min-height: 100vh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 60%, var(--blue) 100%);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 68px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(27,46,74,0.25);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-crest {
            width: 42px; height: 42px;
            background: rgba(255,255,255,0.12);
            border: 1.5px solid rgba(255,255,255,0.25);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 22px;
            color: #fff;
            font-weight: 700;
            line-height: 1.1;
        }

        .logo p {
            font-size: 10.5px;
            color: rgba(255,255,255,0.55);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chip {
            font-size: 12px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chip-glass {
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.85);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .chip-ok { background: rgba(42,143,106,0.2); color: #6ee7b7; border: 1px solid rgba(42,143,106,0.3); }
        .chip-err { background: rgba(201,70,61,0.2); color: #fca5a5; border: 1px solid rgba(201,70,61,0.3); }

        .dot-pulse {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #6ee7b7;
            animation: dotPulse 2s infinite;
        }

        @keyframes dotPulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .4; transform: scale(.8); } }

        .btn-google {
            padding: 7px 16px;
            background: #fff;
            color: var(--navy);
            border: none;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
        }

        .btn-google:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .nav {
            display: flex;
            gap: 3px;
            padding: 10px 32px;
            background: var(--warm-white);
            border-bottom: 1px solid var(--border);
        }

        .nav-btn {
            padding: 10px 22px;
            border: none;
            background: transparent;
            color: var(--text-mid);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover { color: var(--text); background: var(--sand); }

        .nav-btn.active {
            background: var(--blue-soft);
            color: var(--blue);
        }

        .nav-btn .ico { font-size: 16px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main { padding: 28px 32px; max-width: 1050px; margin: 0 auto; }

        .panel { display: none; animation: panelIn .3s ease; }
        .panel.active { display: block; }

        @keyframes panelIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: var(--warm-white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .card-head {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 38px; height: 38px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            flex-shrink: 0;
        }

        .card-head h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 18px;
            font-weight: 700;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .fg { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .fg .full { grid-column: 1/-1; }

        .fi { display: flex; flex-direction: column; gap: 5px; }

        .fi label { font-size: 12px; font-weight: 600; color: var(--text-mid); text-transform: uppercase; letter-spacing: .4px; }

        .fi input, .fi select {
            padding: 11px 14px;
            background: var(--sand);
            border: 1.5px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            transition: all .2s;
            outline: none;
        }

        .fi input:focus, .fi select:focus {
            border-color: var(--blue);
            background: #fff;
            box-shadow: 0 0 0 3px var(--blue-glow);
        }

        .fi input::placeholder { color: var(--text-light); }

        /* Photo upload */
        .photo-area { display: flex; align-items: center; gap: 16px; }

        .photo-circle {
            width: 76px; height: 76px;
            border-radius: 50%;
            background: var(--sand);
            border: 2px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: border-color .2s;
            flex-shrink: 0;
        }

        .photo-circle:hover { border-color: var(--blue); }
        .photo-circle img { width: 100%; height: 100%; object-fit: cover; }
        .photo-circle .ph { font-size: 24px; opacity: .35; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn {
            padding: 11px 22px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            display: inline-flex;
            align-items: center;
            gap: 7px;
        }

        .btn:active { transform: scale(.97); }

        .btn-blue { background: var(--blue); color: #fff; }
        .btn-blue:hover { background: var(--navy-light); box-shadow: 0 4px 14px rgba(59,108,180,.3); transform: translateY(-1px); }

        .btn-green { background: var(--emerald); color: #fff; }
        .btn-green:hover { background: #237a5a; }

        .btn-ghost { background: var(--sand); color: var(--text-mid); }
        .btn-ghost:hover { background: var(--sand-dark); color: var(--text); }

        .btn-red { background: var(--coral-soft); color: var(--coral); }
        .btn-red:hover { background: #f8d4d0; }

        .btn-sm { padding: 7px 14px; font-size: 11.5px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QR DISPLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .qr-result-box {
            display: flex;
            justify-content: center;
            margin-top: 16px;
            padding: 20px;
            background: var(--sand);
            border-radius: var(--radius);
            min-height: 60px;
        }

        .qr-result-box canvas, .qr-result-box img { display: block !important; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(27,46,74,0.45);
            backdrop-filter: blur(6px);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }

        .overlay.open { display: flex; }

        .modal-card {
            background: var(--warm-white);
            border-radius: 20px;
            padding: 36px;
            text-align: center;
            max-width: 440px;
            width: 92%;
            box-shadow: var(--shadow-lg);
            animation: modPop .25s ease;
        }

        @keyframes modPop {
            from { opacity: 0; transform: scale(.93) translateY(8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-card h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .modal-sub { color: var(--text-mid); font-size: 13px; margin-bottom: 18px; }

        .qr-frame {
            display: inline-block;
            padding: 14px;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: var(--radius);
        }

        .qr-frame canvas, .qr-frame img { display: block !important; }

        .modal-btns { display: flex; gap: 8px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tw { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 12px; font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: var(--text-light); font-weight: 700; border-bottom: 2px solid var(--border); background: var(--sand); }
        td { padding: 11px 12px; font-size: 13.5px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: #faf7f2; }

        .cell-name { display: flex; align-items: center; gap: 10px; }

        .av {
            width: 34px; height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: #fff;
            overflow: hidden;
            flex-shrink: 0;
        }

        .av img { width: 100%; height: 100%; object-fit: cover; }

        .tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }

        .tag-ok { background: var(--emerald-soft); color: var(--emerald); }
        .tag-no { background: var(--coral-soft); color: var(--coral); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .scanner-box { display: flex; flex-direction: column; align-items: center; gap: 16px; }

        #reader { width: 100%; max-width: 480px; border-radius: var(--radius); overflow: hidden; border: 2px solid var(--border); }

        #reader__scan_region { border-radius: var(--radius) !important; }
        #reader__dashboard_section_csr button {
            background: var(--blue) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 10px 20px !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 700 !important;
        }
        #reader__dashboard_section_csr select {
            border-radius: 8px !important;
            padding: 6px !important;
            font-family: 'Outfit', sans-serif !important;
        }

        .scan-fb {
            padding: 18px;
            border-radius: var(--radius);
            text-align: center;
            width: 100%;
            max-width: 480px;
            animation: panelIn .3s;
        }

        .scan-fb.ok { background: var(--emerald-soft); border: 1.5px solid var(--emerald); }
        .scan-fb.warn { background: var(--amber-soft); border: 1.5px solid var(--amber); }
        .scan-fb.bad { background: var(--coral-soft); border: 1.5px solid var(--coral); }

        .scan-fb h4 { font-family: 'Crimson Pro', serif; font-size: 17px; margin-bottom: 2px; }
        .scan-fb p { font-size: 12.5px; color: var(--text-mid); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px; margin-bottom: 22px; }

        .stat {
            background: var(--warm-white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid;
        }

        .stat.s-blue { border-left-color: var(--blue); }
        .stat.s-green { border-left-color: var(--emerald); }
        .stat.s-red { border-left-color: var(--coral); }
        .stat.s-amber { border-left-color: var(--amber); }

        .stat-lbl { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text-light); font-weight: 600; }

        .stat-val { font-family: 'Crimson Pro', serif; font-size: 32px; font-weight: 700; margin-top: 2px; }

        .stat.s-blue .stat-val { color: var(--blue); }
        .stat.s-green .stat-val { color: var(--emerald); }
        .stat.s-red .stat-val { color: var(--coral); }
        .stat.s-amber .stat-val { color: var(--amber); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .log-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 0;
            border-bottom: 1px solid var(--border);
        }
        .log-row:last-child { border-bottom: none; }
        .log-left { display: flex; align-items: center; gap: 10px; }
        .log-time { font-size: 12px; font-weight: 600; color: var(--text-mid); background: var(--sand); padding: 3px 10px; border-radius: 6px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .search-wrap { margin-bottom: 16px; }
        .search-wrap input {
            width: 100%;
            padding: 11px 16px 11px 40px;
            background: var(--warm-white);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            color: var(--text);
            outline: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238c95a3' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 14px center;
        }
        .search-wrap input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px var(--blue-glow); }

        .empty { text-align: center; padding: 44px 20px; color: var(--text-light); }
        .empty .emo { font-size: 36px; margin-bottom: 10px; opacity: .4; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast {
            position: fixed; top: 78px; right: 20px;
            padding: 12px 20px; border-radius: var(--radius-sm);
            font-size: 13px; font-weight: 600; z-index: 999;
            box-shadow: var(--shadow-md);
            animation: toastIn .3s ease, toastOut .3s ease 2.7s forwards;
        }
        .toast.ok { background: var(--emerald-soft); color: var(--emerald); border: 1px solid var(--emerald); }
        .toast.bad { background: var(--coral-soft); color: var(--coral); border: 1px solid var(--coral); }

        @keyframes toastIn { from { opacity:0; transform: translateX(40px); } to { opacity:1; transform: translateX(0); } }
        @keyframes toastOut { to { opacity:0; transform: translateX(40px); } }

        .db-box { background: var(--sand); border-radius: var(--radius-sm); padding: 14px; font-family: 'Outfit', monospace; font-size: 12px; overflow-x: auto; margin-top: 8px; border: 1px solid var(--border); color: var(--text-mid); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .header { padding: 0 16px; height: 60px; }
            .header-actions .chip-glass { display: none; }
            .nav { padding: 8px 12px; overflow-x: auto; }
            .nav-btn { padding: 8px 14px; font-size: 13px; white-space: nowrap; }
            .main { padding: 16px; }
            .fg { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â• -->
<header class="header">
    <div class="logo">
        <div class="logo-crest">ğŸ“</div>
        <div>
            <h1>San AgustÃ­n</h1>
            <p>Control de Asistencia</p>
        </div>
    </div>
    <div class="header-actions">
        <div class="chip chip-glass" id="chipTotal">
            <div class="dot-pulse"></div>
            <span id="hdrTotal">0 alumnos</span>
        </div>
        <div class="chip" id="syncChip">â³ Conectando...</div>
        <button class="btn-google" id="authBtn" onclick="handleAuth()" style="display:none;">
            ğŸ”‘ Conectar Google
        </button>
        <button class="btn-google" id="signoutBtn" onclick="handleSignout()" style="display:none;">
            Cerrar sesiÃ³n
        </button>
    </div>
</header>

<!-- â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â• -->
<nav class="nav" id="navBar">
    <button class="nav-btn active" data-p="register"><span class="ico">ğŸ“</span> Registrar</button>
    <button class="nav-btn" data-p="scanner"><span class="ico">ğŸ“·</span> Escanear QR</button>
    <button class="nav-btn" data-p="students"><span class="ico">ğŸ‘¥</span> Estudiantes</button>
    <button class="nav-btn" data-p="attendance"><span class="ico">ğŸ“Š</span> Asistencia</button>
</nav>

<!-- â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â• -->
<main class="main">

<!-- â•â•â• REGISTER â•â•â• -->
<section id="p-register" class="panel active">
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--blue-soft);color:var(--blue);">ğŸ“‹</div>
            <h3>Nuevo Estudiante</h3>
        </div>
        <form id="regForm" onsubmit="registerStudent(event)">
            <div class="fg">
                <div class="fi full">
                    <label>Foto del estudiante</label>
                    <div class="photo-area">
                        <div class="photo-circle" id="photoCircle" onclick="document.getElementById('filePhoto').click()">
                            <div class="ph">ğŸ“·</div>
                        </div>
                        <div>
                            <input type="file" id="filePhoto" accept="image/*" style="display:none" onchange="loadPhoto(this)">
                            <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('filePhoto').click()">Elegir imagen</button>
                            <p style="font-size:11px;color:var(--text-light);margin-top:3px;">Se incluirÃ¡ en el carnet PDF</p>
                        </div>
                    </div>
                </div>
                <div class="fi">
                    <label>Nombre Completo *</label>
                    <input type="text" id="inpName" placeholder="MarÃ­a GarcÃ­a LÃ³pez" required>
                </div>
                <div class="fi">
                    <label>DNI / CÃ³digo *</label>
                    <input type="text" id="inpDni" placeholder="72345678" required>
                </div>
                <div class="fi">
                    <label>Grado *</label>
                    <select id="inpGrade" required>
                        <option value="">Seleccionar...</option>
                        <option>1Â° Primaria</option><option>2Â° Primaria</option><option>3Â° Primaria</option>
                        <option>4Â° Primaria</option><option>5Â° Primaria</option><option>6Â° Primaria</option>
                        <option>1Â° Secundaria</option><option>2Â° Secundaria</option><option>3Â° Secundaria</option>
                        <option>4Â° Secundaria</option><option>5Â° Secundaria</option>
                    </select>
                </div>
                <div class="fi">
                    <label>SecciÃ³n *</label>
                    <select id="inpSection" required>
                        <option value="">Seleccionar...</option>
                        <option>A</option><option>B</option><option>C</option><option>D</option>
                    </select>
                </div>
                <div class="fi full" style="margin-top:4px;">
                    <button type="submit" class="btn btn-blue">ğŸ“± Registrar y Generar QR</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Quick QR test like the example file -->
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--plum-soft);color:var(--plum);">âš¡</div>
            <h3>Generador QR RÃ¡pido (Prueba)</h3>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="text" id="quickQrInput" placeholder="ID o texto para QR" style="flex:1;padding:10px 14px;background:var(--sand);border:1.5px solid var(--border);border-radius:10px;font-family:'Outfit';font-size:14px;outline:none;min-width:200px;">
            <button class="btn btn-blue btn-sm" onclick="quickGenQR()">Generar</button>
        </div>
        <div class="qr-result-box" id="quickQrBox" style="display:none;"></div>
    </div>

    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--amber-soft);color:var(--amber);">ğŸ•</div>
            <h3>Ãšltimos Registros</h3>
        </div>
        <div id="recentList">
            <div class="empty"><div class="emo">ğŸ‘¤</div><p>Registra tu primer estudiante</p></div>
        </div>
    </div>
</section>

<!-- â•â•â• SCANNER â•â•â• -->
<section id="p-scanner" class="panel">
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--emerald-soft);color:var(--emerald);">ğŸ“·</div>
            <h3>EscÃ¡ner de Asistencia</h3>
        </div>
        <div class="scanner-box">
            <div style="display:flex;gap:16px;margin-bottom:8px;">
                <label style="display:flex;align-items:center;gap:6px;font-weight:600;font-size:14px;cursor:pointer;">
                    <input type="radio" name="scanMode" value="ENTRADA" checked> ğŸŸ¢ Entrada
                </label>
                <label style="display:flex;align-items:center;gap:6px;font-weight:600;font-size:14px;cursor:pointer;">
                    <input type="radio" name="scanMode" value="SALIDA"> ğŸ”´ Salida
                </label>
            </div>
            <div id="reader"></div>
            <p style="font-size:12.5px;color:var(--text-light);text-align:center;">Apunte al QR del carnet del estudiante</p>
            <div id="scanFeedback"></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--amber-soft);color:var(--amber);">ğŸ“‹</div>
            <h3>Registros de Hoy</h3>
        </div>
        <div id="todayLog">
            <div class="empty"><div class="emo">ğŸ“±</div><p>Escanea un QR para comenzar</p></div>
        </div>
    </div>
</section>

<!-- â•â•â• STUDENTS â•â•â• -->
<section id="p-students" class="panel">
    <div class="search-wrap">
        <input type="text" id="searchBox" placeholder="Buscar por nombre, DNI o grado..." oninput="renderStudents()">
    </div>
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--blue-soft);color:var(--blue);">ğŸ‘¥</div>
            <h3>Lista de Estudiantes</h3>
        </div>
        <div class="tw">
            <table>
                <thead><tr><th>Estudiante</th><th>DNI</th><th>Grado</th><th>SecciÃ³n</th><th>Hoy</th><th>Acciones</th></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
        <div id="tEmpty" class="empty" style="display:none;"><div class="emo">ğŸ“‹</div><p>Sin estudiantes</p></div>
    </div>
</section>

<!-- â•â•â• ATTENDANCE â•â•â• -->
<section id="p-attendance" class="panel">
    <div class="stats">
        <div class="stat s-blue"><div class="stat-lbl">Total Alumnos</div><div class="stat-val" id="sTotal">0</div></div>
        <div class="stat s-green"><div class="stat-lbl">Presentes</div><div class="stat-val" id="sPresent">0</div></div>
        <div class="stat s-red"><div class="stat-lbl">Ausentes</div><div class="stat-val" id="sAbsent">0</div></div>
        <div class="stat s-amber"><div class="stat-lbl">% Asistencia</div><div class="stat-val" id="sPct">0%</div></div>
    </div>
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--emerald-soft);color:var(--emerald);">ğŸ“Š</div>
            <h3>Historial de Asistencia</h3>
        </div>
        <div id="attHistory">
            <div class="empty"><div class="emo">ğŸ“…</div><p>No hay registros aÃºn</p></div>
        </div>
    </div>
    <div class="card">
        <div class="card-head">
            <div class="card-icon" style="background:var(--plum-soft);color:var(--plum);">ğŸ—„ï¸</div>
            <h3>Estructura Google Sheets</h3>
        </div>
        <p style="font-size:13px;color:var(--text-mid);margin-bottom:8px;">El spreadsheet debe tener 2 hojas con estos encabezados en la fila 1:</p>
        <p style="font-weight:700;font-size:13px;">ğŸ“„ Hoja: <code>Estudiantes</code></p>
        <div class="db-box">id | nombre | dni | grado | seccion | foto_base64 | fecha_registro</div>
        <p style="font-weight:700;font-size:13px;margin-top:12px;">ğŸ“„ Hoja: <code>Asistencia</code></p>
        <div class="db-box">id_estudiante | nombre | dni | grado | seccion | fecha | hora | tipo</div>
    </div>
</section>

</main>

<!-- â•â•â•â•â•â•â•â• QR MODAL â•â•â•â•â•â•â•â• -->
<div class="overlay" id="qrOverlay">
    <div class="modal-card">
        <h3 id="mName"></h3>
        <p class="modal-sub" id="mInfo"></p>
        <div class="qr-frame" id="mQR"></div>
        <div class="modal-btns">
            <button class="btn btn-blue btn-sm" onclick="downloadPDF()">ğŸ“„ Descargar Carnet PDF</button>
            <button class="btn btn-ghost btn-sm" onclick="downloadQROnly()">ğŸ–¼ï¸ Solo QR (PNG)</button>
            <button class="btn btn-red btn-sm" onclick="closeModal()">Cerrar</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID = '814005655098-8csk41qts3okv4b2fjnq7ls4qc2kq0vc.apps.googleusercontent.com';
const API_KEY = 'AIzaSyAOhGTjJXHhuUhqf1g2DPCla59xNzftb-Q';
const SPREADSHEET_ID = '1m0rv2gcMW3E8Yrh02PnwtHgZ3utj8XRPa9kYpwwm5oo';
const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

let tokenClient;
let gapiInited = false;
let gisInited = false;
let isAuthed = false;

function onGapiLoad() {
    gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true;
        maybeEnableAuth();
    });
}

function onGisLoad() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '' // set later
    });
    gisInited = true;
    maybeEnableAuth();
}

function maybeEnableAuth() {
    if (gapiInited && gisInited) {
        document.getElementById('authBtn').style.display = 'flex';
        // Auto try loading with API key (read-only)
        loadDataFromSheets();
    }
}

function handleAuth() {
    tokenClient.callback = async (resp) => {
        if (resp.error) {
            setSyncChip('err', 'âœ— Error de autenticaciÃ³n');
            return;
        }
        isAuthed = true;
        document.getElementById('authBtn').style.display = 'none';
        document.getElementById('signoutBtn').style.display = 'flex';
        setSyncChip('ok', 'âœ“ Google Sheets conectado');
        await loadDataFromSheets();
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        tokenClient.requestAccessToken({ prompt: '' });
    }
}

function handleSignout() {
    const token = gapi.client.getToken();
    if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
    }
    isAuthed = false;
    document.getElementById('authBtn').style.display = 'flex';
    document.getElementById('signoutBtn').style.display = 'none';
    setSyncChip('glass', 'ğŸ”‘ No conectado');
}

function setSyncChip(type, text) {
    const el = document.getElementById('syncChip');
    el.className = 'chip';
    if (type === 'ok') el.classList.add('chip-ok');
    else if (type === 'err') el.classList.add('chip-err');
    else el.classList.add('chip-glass');
    el.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SHEETS READ / WRITE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sheetsRead(range) {
    try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: range
        });
        return resp.result.values || [];
    } catch(e) {
        console.warn('Sheets read error:', e);
        return null;
    }
}

async function sheetsAppend(sheet, rowValues) {
    try {
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: sheet,
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: [rowValues] }
        });
        return true;
    } catch(e) {
        console.warn('Sheets append error:', e);
        return false;
    }
}

async function loadDataFromSheets() {
    setSyncChip('glass', 'â³ Cargando...');
    const sData = await sheetsRead('Estudiantes!A2:G');
    if (sData === null) {
        setSyncChip('err', 'âœ— Error lectura â€” modo local');
        const s = localStorage.getItem('school_v2');
        if (s) db = JSON.parse(s);
        refreshAll();
        return;
    }
    db.students = sData.map(r => ({
        id: r[0]||'', name: r[1]||'', dni: r[2]||'', grade: r[3]||'', section: r[4]||'', photo: r[5]||'', createdAt: r[6]||''
    }));

    const aData = await sheetsRead('Asistencia!A2:H');
    if (aData) {
        db.attendance = aData.map(r => ({
            sid: r[0]||'', name: r[1]||'', dni: r[2]||'', grade: r[3]||'', section: r[4]||'', date: r[5]||'', time: r[6]||'', type: r[7]||'ENTRADA'
        }));
    }
    saveLocal();
    setSyncChip('ok', 'âœ“ Sincronizado');
    refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOCAL DATA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = { students: [], attendance: [] };
let currStudent = null;
let currPhoto = null;

function saveLocal() { localStorage.setItem('school_v2', JSON.stringify(db)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const today = () => new Date().toISOString().split('T')[0];
const timeNow = () => new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2,6);
const PALETTE = ['#3b6cb4','#2a8f6a','#c68a1d','#6b4c8a','#c9463d','#0891b2','#be185d','#4f46e5','#ea580c','#0d9488'];
const pick = (s) => { let h=0; for(let c of s) h=c.charCodeAt(0)+((h<<5)-h); return PALETTE[Math.abs(h)%PALETTE.length]; };
const ini = (n) => n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

function avHTML(s, sz=34) {
    if (s.photo) return `<div class="av" style="width:${sz}px;height:${sz}px;"><img src="${s.photo}"></div>`;
    return `<div class="av" style="width:${sz}px;height:${sz}px;background:${pick(s.name)};font-size:${sz*.35}px;">${ini(s.name)}</div>`;
}

function toast(msg, ok=true) {
    const t = document.createElement('div');
    t.className = `toast ${ok?'ok':'bad'}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 3100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let qrScanner = null;
let scanActive = false;

document.getElementById('navBar').addEventListener('click', e => {
    const btn = e.target.closest('.nav-btn');
    if (!btn) return;
    const p = btn.dataset.p;
    document.querySelectorAll('.panel').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('p-'+p).classList.add('active');
    btn.classList.add('active');
    if (p === 'scanner') initScanner();
    else stopScanner();
    if (p === 'students') renderStudents();
    if (p === 'attendance') renderAttendance();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PHOTO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadPhoto(inp) {
    const f = inp.files[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const c = document.createElement('canvas');
            const M = 180;
            let w=img.width, h=img.height;
            if(w>h){h=(h/w)*M;w=M;} else {w=(w/h)*M;h=M;}
            c.width=w; c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            currPhoto = c.toDataURL('image/jpeg', 0.7);
            document.getElementById('photoCircle').innerHTML = `<img src="${currPhoto}">`;
        };
        img.src = e.target.result;
    };
    rd.readAsDataURL(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REGISTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function registerStudent(e) {
    e.preventDefault();
    const name = document.getElementById('inpName').value.trim();
    const dni = document.getElementById('inpDni').value.trim();
    const grade = document.getElementById('inpGrade').value;
    const section = document.getElementById('inpSection').value;

    if (db.students.find(s=>s.dni===dni)) {
        toast('Ya existe un estudiante con ese DNI', false);
        return;
    }

    const student = { id: uid(), name, dni, grade, section, photo: currPhoto||'', createdAt: new Date().toISOString() };
    db.students.push(student);
    saveLocal();

    // Save to Sheets
    if (isAuthed) {
        const ok = await sheetsAppend('Estudiantes', [student.id, student.name, student.dni, student.grade, student.section, student.photo, student.createdAt]);
        if (!ok) toast('âš  Guardado local (error en Sheets)', false);
    }

    showQRModal(student);

    document.getElementById('regForm').reset();
    document.getElementById('photoCircle').innerHTML = '<div class="ph">ğŸ“·</div>';
    currPhoto = null;
    renderRecent();
    updateHdr();
    toast('âœ“ Estudiante registrado');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QR GENERATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Follows the SAME pattern as the working example file
function generateQRInto(container, text, size=180) {
    container.innerHTML = ''; // Clear previous (same as example)
    if (!text || text.trim() === '') return;
    new QRCode(container, {
        text: text,
        width: size,
        height: size,
        colorDark: '#1b2e4a',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
}

// Quick QR (like example file)
function quickGenQR() {
    const txt = document.getElementById('quickQrInput').value;
    if (!txt.trim()) { alert('Escribe un ID o texto'); return; }
    const box = document.getElementById('quickQrBox');
    box.style.display = 'flex';
    generateQRInto(box, txt, 160);
}

function showQRModal(student) {
    currStudent = student;
    document.getElementById('mName').textContent = student.name;
    document.getElementById('mInfo').textContent = `${student.grade} "${student.section}" â€” DNI: ${student.dni}`;

    // Each QR is unique: includes the full student data + unique ID
    const qrData = JSON.stringify({
        id: student.id,
        name: student.name,
        dni: student.dni,
        grade: student.grade,
        section: student.section
    });

    generateQRInto(document.getElementById('mQR'), qrData, 200);
    document.getElementById('qrOverlay').classList.add('open');
}

function closeModal() {
    document.getElementById('qrOverlay').classList.remove('open');
    currStudent = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOWNLOAD QR IMAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadQROnly() {
    const c = document.querySelector('#mQR canvas');
    const i = document.querySelector('#mQR img');
    const src = c ? c.toDataURL('image/png') : (i ? i.src : null);
    if (!src) { toast('No se pudo obtener QR', false); return; }
    const a = document.createElement('a');
    a.href = src;
    a.download = `QR_${currStudent.name.replace(/\s/g,'_')}.png`;
    a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOWNLOAD CARNET PDF â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadPDF() {
    const s = currStudent;
    if (!s) return;
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'landscape', unit:'mm', format:[92,58] });

    // Background
    pdf.setFillColor(27,46,74); pdf.rect(0,0,92,21,'F');  // Navy header
    pdf.setFillColor(253,248,240); pdf.rect(0,21,92,37,'F'); // Cream body
    pdf.setFillColor(59,108,180); pdf.rect(0,21,92,1.5,'F'); // Blue accent

    // Header text
    pdf.setFont('helvetica','bold'); pdf.setFontSize(9.5); pdf.setTextColor(255,255,255);
    pdf.text('COLEGIO SAN AGUSTÃN', 46, 8, {align:'center'});
    pdf.setFont('helvetica','normal'); pdf.setFontSize(5.5); pdf.setTextColor(160,185,220);
    pdf.text('CARNET DE IDENTIFICACIÃ“N ESTUDIANTIL', 46, 12.5, {align:'center'});
    pdf.text('AÃ‘O ESCOLAR ' + new Date().getFullYear(), 46, 16, {align:'center'});

    // Photo
    const px=5, py=25, ps=17;
    if (s.photo) {
        try { pdf.addImage(s.photo,'JPEG',px,py,ps,ps); } catch(e) { drawInitials(); }
    } else { drawInitials(); }
    function drawInitials() {
        pdf.setFillColor(59,108,180); pdf.rect(px,py,ps,ps,'F');
        pdf.setFont('helvetica','bold'); pdf.setFontSize(11); pdf.setTextColor(255,255,255);
        pdf.text(ini(s.name), px+ps/2, py+ps/2+3, {align:'center'});
    }
    pdf.setDrawColor(59,108,180); pdf.setLineWidth(0.4); pdf.rect(px,py,ps,ps);

    // Student Info
    const ix = 25;
    pdf.setTextColor(27,46,74); pdf.setFont('helvetica','bold'); pdf.setFontSize(7.5);
    pdf.text(s.name.toUpperCase(), ix, 29);
    pdf.setFont('helvetica','normal'); pdf.setFontSize(5.8); pdf.setTextColor(90,100,114);
    pdf.text('DNI: ' + s.dni, ix, 34);
    pdf.text('Grado: ' + s.grade, ix, 38);
    pdf.text('SecciÃ³n: ' + s.section, ix, 42);

    // QR on card
    const qc = document.querySelector('#mQR canvas');
    const qi = document.querySelector('#mQR img');
    const qsrc = qc ? qc.toDataURL('image/png') : (qi ? qi.src : null);
    if (qsrc) {
        pdf.addImage(qsrc, 'PNG', 67, 24, 20, 20);
        pdf.setDrawColor(200,210,220); pdf.setLineWidth(0.25); pdf.rect(67,24,20,20);
    }

    // Footer
    pdf.setFontSize(4.2); pdf.setTextColor(140,149,163);
    pdf.text('Este carnet es personal e intransferible', 46, 49, {align:'center'});
    pdf.text('ID: ' + s.id, 46, 52.5, {align:'center'});
    pdf.setFillColor(59,108,180); pdf.rect(0,56.5,92,1.5,'F');

    pdf.save(`Carnet_${s.name.replace(/\s/g,'_')}.pdf`);
    toast('âœ“ Carnet PDF descargado');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initScanner() {
    if (qrScanner) return;
    qrScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    }, false);
    qrScanner.render(onScanOk, ()=>{});
    scanActive = true;
}

function stopScanner() {
    if (qrScanner && scanActive) {
        try { qrScanner.clear(); } catch(e){}
        qrScanner = null;
        scanActive = false;
    }
}

let lastScan = 0;

async function onScanOk(decoded) {
    const now = Date.now();
    if (now - lastScan < 3500) return;
    lastScan = now;

    const mode = document.querySelector('input[name="scanMode"]:checked').value;
    let data;
    try { data = JSON.parse(decoded); } catch {
        scanFB('bad', 'QR no vÃ¡lido', 'No pertenece a este sistema');
        return;
    }

    const student = db.students.find(s => s.id === data.id);
    if (!student) {
        scanFB('bad', 'No encontrado', 'Este QR no corresponde a ningÃºn alumno registrado');
        return;
    }

    const d = today();
    const dup = db.attendance.find(a => a.sid === student.id && a.date === d && a.type === mode);
    if (dup) {
        scanFB('warn', student.name, `Ya tiene ${mode} registrada hoy (${dup.time})`);
        return;
    }

    const t = timeNow();
    const rec = { sid:student.id, name:student.name, dni:student.dni, grade:student.grade, section:student.section, date:d, time:t, type:mode };
    db.attendance.push(rec);
    saveLocal();

    if (isAuthed) {
        await sheetsAppend('Asistencia', [rec.sid, rec.name, rec.dni, rec.grade, rec.section, rec.date, rec.time, rec.type]);
    }

    scanFB('ok', `âœ“ ${student.name}`, `${mode} registrada â€” ${t} | ${student.grade} "${student.section}"`);
    renderTodayLog();
    updateHdr();

    // Sound feedback
    try {
        const ax = new (window.AudioContext||window.webkitAudioContext)();
        const o = ax.createOscillator(); const g = ax.createGain();
        o.connect(g); g.connect(ax.destination);
        o.frequency.value = 800; g.gain.value = 0.1;
        o.start();
        setTimeout(()=>{o.frequency.value=1200;},80);
        setTimeout(()=>{o.stop();ax.close();},180);
    } catch(e){}
}

function scanFB(type, title, msg) {
    const el = document.getElementById('scanFeedback');
    el.innerHTML = `<div class="scan-fb ${type}"><h4>${title}</h4><p>${msg}</p></div>`;
    setTimeout(()=>{el.innerHTML='';}, 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecent() {
    const el = document.getElementById('recentList');
    const r = [...db.students].reverse().slice(0,5);
    if (!r.length) { el.innerHTML = '<div class="empty"><div class="emo">ğŸ‘¤</div><p>Registra tu primer estudiante</p></div>'; return; }
    el.innerHTML = r.map(s=>`
        <div class="log-row">
            <div class="log-left">
                ${avHTML(s)}
                <div>
                    <div style="font-weight:700;font-size:14px;">${s.name}</div>
                    <div style="font-size:12px;color:var(--text-mid);">${s.grade} "${s.section}" â€” ${s.dni}</div>
                </div>
            </div>
            <div style="display:flex;gap:5px;flex-shrink:0;">
                <button class="btn btn-blue btn-sm" onclick='openQR("${s.id}")'>ğŸ“± QR</button>
                <button class="btn btn-red btn-sm" onclick='delStudent("${s.id}")'>âœ•</button>
            </div>
        </div>`).join('');
}

function renderStudents() {
    const tbody = document.getElementById('tBody');
    const emp = document.getElementById('tEmpty');
    const q = (document.getElementById('searchBox')?.value||'').toLowerCase();
    let list = db.students;
    if (q) list = list.filter(s=>s.name.toLowerCase().includes(q)||s.dni.toLowerCase().includes(q)||s.grade.toLowerCase().includes(q));
    if (!list.length) { tbody.innerHTML=''; emp.style.display='block'; return; }
    emp.style.display='none';
    const d = today();
    tbody.innerHTML = list.map(s => {
        const att = db.attendance.find(a=>a.sid===s.id&&a.date===d&&a.type==='ENTRADA');
        const tag = att ? '<span class="tag tag-ok">âœ“ Presente</span>' : '<span class="tag tag-no">âœ— Ausente</span>';
        return `<tr>
            <td><div class="cell-name">${avHTML(s)} ${s.name}</div></td>
            <td style="font-weight:600;">${s.dni}</td>
            <td>${s.grade}</td>
            <td>${s.section}</td>
            <td>${tag}</td>
            <td><div style="display:flex;gap:5px;">
                <button class="btn btn-blue btn-sm" onclick='openQR("${s.id}")'>ğŸ“±</button>
                <button class="btn btn-red btn-sm" onclick='delStudent("${s.id}")'>âœ•</button>
            </div></td>
        </tr>`;
    }).join('');
}

function renderTodayLog() {
    const el = document.getElementById('todayLog');
    const recs = db.attendance.filter(a=>a.date===today()).reverse();
    if (!recs.length) { el.innerHTML='<div class="empty"><div class="emo">ğŸ“±</div><p>Escanea un QR</p></div>'; return; }
    el.innerHTML = recs.map(a => {
        const s = db.students.find(x=>x.id===a.sid) || {name:a.name,photo:''};
        const color = a.type==='ENTRADA' ? 'var(--emerald)' : 'var(--coral)';
        return `<div class="log-row">
            <div class="log-left">
                ${avHTML(s,30)}
                <div>
                    <span style="font-weight:700;font-size:13px;">${a.name}</span>
                    <span style="font-size:11px;color:${color};font-weight:700;margin-left:6px;">${a.type}</span>
                </div>
            </div>
            <div class="log-time">${a.time}</div>
        </div>`;
    }).join('');
}

function renderAttendance() {
    const d = today();
    const total = db.students.length;
    const pres = db.attendance.filter(a=>a.date===d&&a.type==='ENTRADA').length;
    document.getElementById('sTotal').textContent = total;
    document.getElementById('sPresent').textContent = pres;
    document.getElementById('sAbsent').textContent = total - pres;
    document.getElementById('sPct').textContent = total>0 ? Math.round(pres/total*100)+'%' : '0%';

    const el = document.getElementById('attHistory');
    const dates = [...new Set(db.attendance.map(a=>a.date))].sort().reverse();
    if (!dates.length) { el.innerHTML='<div class="empty"><div class="emo">ğŸ“…</div><p>Sin registros</p></div>'; return; }
    el.innerHTML = dates.map(date => {
        const recs = db.attendance.filter(a=>a.date===date);
        const fmt = new Date(date+'T12:00:00').toLocaleDateString('es',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        const entries = recs.filter(r=>r.type==='ENTRADA').length;
        return `<div style="margin-bottom:18px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <span style="font-weight:700;text-transform:capitalize;font-size:14px;">${fmt}</span>
                <span class="tag tag-ok">${entries} entradas</span>
            </div>
            ${recs.map(a=>{
                const st = db.students.find(x=>x.id===a.sid)||{name:a.name,photo:''};
                const clr = a.type==='ENTRADA'?'var(--emerald)':'var(--coral)';
                return `<div class="log-row" style="padding:7px 0;">
                    <div class="log-left">${avHTML(st,26)}
                        <span style="font-size:13px;">${a.name}</span>
                        <span style="font-size:10px;color:${clr};font-weight:700;">${a.type}</span>
                    </div>
                    <div class="log-time">${a.time}</div>
                </div>`;
            }).join('')}
        </div>`;
    }).join('');
}

function updateHdr() {
    const d = today();
    const t = db.students.length;
    const p = db.attendance.filter(a=>a.date===d&&a.type==='ENTRADA').length;
    document.getElementById('hdrTotal').textContent = `${t} alumno${t!==1?'s':''}`;
}

function refreshAll() { updateHdr(); renderRecent(); renderTodayLog(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openQR(id) {
    const s = db.students.find(x=>x.id===id);
    if (s) showQRModal(s);
}

function delStudent(id) {
    if (!confirm('Â¿Eliminar este estudiante?')) return;
    db.students = db.students.filter(s=>s.id!==id);
    db.attendance = db.attendance.filter(a=>a.sid!==id);
    saveLocal();
    refreshAll();
    renderStudents();
    toast('Estudiante eliminado');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
    const s = localStorage.getItem('school_v2');
    if (s) db = JSON.parse(s);
    refreshAll();
})();
</script>
</body>
</html>
