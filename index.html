<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1b2e4a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema de Asistencia QR ‚Äî Colegio San Agust√≠n</title>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
/* ============================================================
   styles.css ‚Äî Sistema de Asistencia QR ¬∑ Colegio San Agust√≠n
   Dise√±o responsive, amigable, moderno
   ============================================================ */

/* === VARIABLES === */
:root {
    --cream: #fdf8f0;
    --white: #ffffff;
    --sand: #f0e9dc;
    --sand2: #e5dace;
    --navy: #1b2e4a;
    --navyL: #2d4a73;
    --blue: #3b6cb4;
    --blueS: #e8f0fb;
    --blueG: #d0e2f7;
    --green: #2a8f6a;
    --greenS: #dff5ec;
    --greenL: #6ee7b7;
    --red: #c9463d;
    --redS: #fce8e6;
    --amber: #c68a1d;
    --amberS: #fdf3dc;
    --txt: #2c2c2c;
    --txt2: #5a6472;
    --txt3: #8c95a3;
    --brd: #e4ddd3;
    --r: 14px;
    --rs: 10px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,.08);
    --shadow-lg: 0 8px 30px rgba(0,0,0,.12);
}

/* === RESET === */
*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: 'Outfit', sans-serif;
    background: var(--cream);
    color: var(--txt);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
}

/* === ENCABEZADO === */
.header {
    background: linear-gradient(135deg, var(--navy), var(--navyL) 60%, var(--blue));
    padding: 0 20px;
    height: 58px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(27,46,74,.25);
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-icon {
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,.12);
    border: 1.5px solid rgba(255,255,255,.2);
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.logo h1 {
    font-family: 'Crimson Pro', serif;
    font-size: 17px;
    color: #fff;
    line-height: 1.1;
}

.logo small {
    font-size: 9px;
    color: rgba(255,255,255,.5);
    letter-spacing: 1.5px;
    text-transform: uppercase;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Chips de estado */
.chip {
    font-size: 10px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

.chip-g { background: rgba(255,255,255,.1); color: rgba(255,255,255,.8); }
.chip-ok { background: rgba(42,143,106,.25); color: var(--greenL); }
.chip-err { background: rgba(201,70,61,.25); color: #fca5a5; }

/* Bot√≥n de autenticaci√≥n */
.btn-auth {
    padding: 5px 12px;
    background: #fff;
    color: var(--navy);
    border: none;
    border-radius: 7px;
    font-family: 'Outfit', sans-serif;
    font-size: 10.5px;
    font-weight: 700;
    cursor: pointer;
    transition: background .2s;
    white-space: nowrap;
}
.btn-auth:hover { background: var(--blueG); }

/* === NAVEGACI√ìN === */
.nav {
    display: flex;
    gap: 2px;
    padding: 8px 16px;
    background: var(--white);
    border-bottom: 1px solid var(--brd);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}
.nav::-webkit-scrollbar { display: none; }

.nav-btn {
    padding: 9px 14px;
    border: none;
    background: transparent;
    color: var(--txt2);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    font-weight: 600;
    border-radius: var(--rs);
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
}
.nav-btn:hover { background: var(--sand); color: var(--txt); }
.nav-btn.active { background: var(--blueS); color: var(--blue); }

/* === CONTENIDO PRINCIPAL === */
.main {
    padding: 16px;
    max-width: 900px;
    margin: 0 auto;
}

/* Paneles */
.panel {
    display: none;
    animation: fadeIn .25s ease;
}
.panel.active { display: block; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
}

/* === TARJETAS === */
.card {
    background: var(--white);
    border: 1px solid var(--brd);
    border-radius: var(--r);
    padding: 18px;
    margin-bottom: 14px;
    box-shadow: var(--shadow-sm);
}

.card-title {
    font-family: 'Crimson Pro', serif;
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--brd);
    display: flex;
    align-items: center;
    gap: 8px;
}

/* === FORMULARIOS === */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.form-grid .full { grid-column: 1 / -1; }

.field {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.field label {
    font-size: 11px;
    font-weight: 600;
    color: var(--txt2);
    text-transform: uppercase;
    letter-spacing: .3px;
}

.field input,
.field select {
    padding: 10px 12px;
    background: var(--sand);
    border: 1.5px solid transparent;
    border-radius: var(--rs);
    color: var(--txt);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    outline: none;
    transition: all .2s;
    width: 100%;
}
.field input:focus,
.field select:focus {
    border-color: var(--blue);
    background: #fff;
    box-shadow: 0 0 0 3px var(--blueG);
}

/* Foto de perfil */
.photo-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.photo-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--sand);
    border: 2px dashed var(--brd);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    cursor: pointer;
    flex-shrink: 0;
    transition: border-color .2s;
    font-size: 20px;
}
.photo-circle:hover { border-color: var(--blue); }
.photo-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* === BOTONES === */
.btn {
    padding: 10px 18px;
    border: none;
    border-radius: var(--rs);
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
}
.btn:active { transform: scale(.97); }

.btn-blue { background: var(--blue); color: #fff; }
.btn-blue:hover { background: var(--navyL); }
.btn-green { background: var(--green); color: #fff; }
.btn-green:hover { background: #238e5c; }
.btn-ghost { background: var(--sand); color: var(--txt2); }
.btn-ghost:hover { background: var(--sand2); }
.btn-red { background: var(--redS); color: var(--red); }
.btn-red:hover { background: #f8d4d0; }
.btn-sm { padding: 7px 12px; font-size: 11px; }
.btn-block { width: 100%; }

/* === C√ìDIGO QR === */
.qr-container {
    margin-top: 14px;
    display: flex;
    justify-content: center;
    padding: 16px;
    background: var(--sand);
    border-radius: var(--r);
    min-height: 20px;
}
.qr-container canvas { display: block !important; margin: 0 auto; }
.qr-container img { display: none !important; }

.qr-actions {
    margin-top: 10px;
    display: none;
    gap: 6px;
    justify-content: center;
    flex-wrap: wrap;
}
.qr-actions.visible { display: flex; }

.qr-status {
    text-align: center;
    margin-top: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
}

/* === TABLAS === */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 480px;
}

th {
    text-align: left;
    padding: 8px 10px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: .6px;
    color: var(--txt3);
    font-weight: 700;
    border-bottom: 2px solid var(--brd);
    background: var(--sand);
    white-space: nowrap;
}

td {
    padding: 9px 10px;
    font-size: 13px;
    border-bottom: 1px solid var(--brd);
}

tr:hover td { background: #faf7f2; }

/* Nombre con avatar */
.cell-name {
    display: flex;
    align-items: center;
    gap: 8px;
}

.avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 10px;
    color: #fff;
    overflow: hidden;
    flex-shrink: 0;
}
.avatar img { width: 100%; height: 100%; object-fit: cover; }

/* Etiquetas de estado */
.tag {
    padding: 2px 8px;
    border-radius: 16px;
    font-size: 10px;
    font-weight: 700;
    display: inline-block;
}
.tag-ok { background: var(--greenS); color: var(--green); }
.tag-no { background: var(--redS); color: var(--red); }
.tag-warn { background: var(--amberS); color: var(--amber); }

/* === ESC√ÅNER === */
#reader {
    width: 100%;
    max-width: 460px;
    margin: 0 auto;
    border-radius: var(--r);
    overflow: hidden;
}

.scan-mode-selector {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 12px;
}

.scan-mode-selector label {
    cursor: pointer;
    padding: 6px 14px;
    border-radius: var(--rs);
    font-size: 13px;
    font-weight: 600;
    transition: all .2s;
    border: 1.5px solid var(--brd);
    background: var(--white);
}
.scan-mode-selector input[type="radio"] { display: none; }
.scan-mode-selector input[type="radio"]:checked + span {
    /* Manejado por JS */
}
.scan-mode-selector .mode-entrada { }
.scan-mode-selector .mode-salida { }
.mode-active-entrada { background: var(--greenS) !important; border-color: var(--green) !important; color: var(--green); }
.mode-active-salida { background: var(--redS) !important; border-color: var(--red) !important; color: var(--red); }

/* Retroalimentaci√≥n del escaneo */
.scan-feedback {
    padding: 16px;
    border-radius: var(--r);
    text-align: center;
    max-width: 460px;
    margin: 12px auto 0;
    animation: fadeIn .25s ease;
}
.scan-feedback h4 { font-size: 16px; margin-bottom: 4px; }
.scan-feedback p { font-size: 13px; opacity: .85; }
.scan-feedback.ok { background: var(--greenS); border: 1.5px solid var(--green); color: var(--green); }
.scan-feedback.bad { background: var(--redS); border: 1.5px solid var(--red); color: var(--red); }
.scan-feedback.warn { background: var(--amberS); border: 1.5px solid var(--amber); color: var(--amber); }

/* === ESTAD√çSTICAS === */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 14px;
}

.stat-card {
    background: var(--white);
    border: 1px solid var(--brd);
    border-radius: var(--r);
    padding: 14px;
    border-left: 4px solid;
}
.stat-card.blue { border-left-color: var(--blue); }
.stat-card.green { border-left-color: var(--green); }
.stat-card.amber { border-left-color: var(--amber); }
.stat-card.red { border-left-color: var(--red); }

.stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: .4px;
    color: var(--txt3);
    font-weight: 600;
}

.stat-value {
    font-family: 'Crimson Pro', serif;
    font-size: 28px;
    font-weight: 700;
}
.stat-card.blue .stat-value { color: var(--blue); }
.stat-card.green .stat-value { color: var(--green); }
.stat-card.amber .stat-value { color: var(--amber); }
.stat-card.red .stat-value { color: var(--red); }

/* Lista de registros recientes */
.list-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 0;
    border-bottom: 1px solid var(--brd);
    gap: 8px;
}
.list-row:last-child { border-bottom: none; }

.list-time {
    font-size: 11px;
    font-weight: 600;
    color: var(--txt2);
    background: var(--sand);
    padding: 3px 8px;
    border-radius: 5px;
    white-space: nowrap;
}

/* Campo de b√∫squeda */
.search-box {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 12px;
    border-radius: var(--rs);
    border: 1.5px solid var(--brd);
    background: var(--white);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    color: var(--txt);
    outline: none;
    transition: all .2s;
}
.search-box:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px var(--blueG);
}

/* === REPORTES === */
.report-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 14px;
    align-items: flex-end;
}

.report-filters .field { flex: 1; min-width: 120px; }

.report-summary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
}

/* === MODAL / OVERLAY === */
.overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(27,46,74,.45);
    backdrop-filter: blur(4px);
    z-index: 500;
    align-items: center;
    justify-content: center;
    padding: 16px;
}
.overlay.open { display: flex; }

.modal {
    background: var(--white);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    max-width: 380px;
    width: 100%;
    box-shadow: var(--shadow-lg);
    animation: modalIn .2s ease;
}

@keyframes modalIn {
    from { opacity: 0; transform: scale(.95); }
    to { opacity: 1; transform: scale(1); }
}

.modal h3 { font-family: 'Crimson Pro', serif; font-size: 18px; margin-bottom: 4px; }
.modal .modal-sub { font-size: 12px; color: var(--txt2); margin-bottom: 14px; }
.modal .qr-wrap canvas { display: block !important; margin: 0 auto; }
.modal .qr-wrap img { display: none !important; }
.modal-btns { margin-top: 14px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

/* === NOTIFICACI√ìN CENTRAL (TOAST) === */
.toast-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.toast {
    background: var(--white);
    border-radius: 16px;
    padding: 20px 28px;
    text-align: center;
    box-shadow: 0 12px 40px rgba(0,0,0,.2);
    pointer-events: auto;
    animation: toastIn .3s ease, toastOut .3s ease 2.7s forwards;
    min-width: 240px;
    max-width: 340px;
}

.toast-icon { font-size: 32px; margin-bottom: 6px; }
.toast h4 { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.toast p { font-size: 12px; color: var(--txt2); }
.toast.ok { border: 2px solid var(--green); }
.toast.bad { border: 2px solid var(--red); }
.toast.warn { border: 2px solid var(--amber); }
.toast.info { border: 2px solid var(--blue); }

@keyframes toastIn {
    from { opacity: 0; transform: scale(.85); }
    to { opacity: 1; transform: scale(1); }
}
@keyframes toastOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(.85); }
}

/* Mensaje vac√≠o */
.empty-msg {
    text-align: center;
    padding: 24px;
    color: var(--txt3);
    font-size: 13px;
}

/* === RESPONSIVE === */

/* Tablets */
@media (max-width: 768px) {
    .header { padding: 0 14px; height: 54px; }
    .logo h1 { font-size: 15px; }
    .logo small { font-size: 8px; }
    .logo-icon { width: 32px; height: 32px; font-size: 14px; }
    .main { padding: 12px; }
    .card { padding: 14px; }
    .form-grid { gap: 8px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .report-filters { flex-direction: column; }
    .report-filters .field { min-width: 100%; }
}

/* M√≥viles */
@media (max-width: 480px) {
    .header { padding: 0 10px; height: 50px; }
    .logo h1 { font-size: 14px; }
    .logo-icon { width: 28px; height: 28px; font-size: 13px; }
    .chip { font-size: 9px; padding: 3px 7px; }
    .btn-auth { font-size: 9.5px; padding: 4px 8px; }
    .nav { padding: 6px 10px; gap: 1px; }
    .nav-btn { padding: 7px 10px; font-size: 12px; gap: 4px; }
    .main { padding: 8px; }
    .card { padding: 12px; margin-bottom: 10px; border-radius: 12px; }
    .card-title { font-size: 14px; margin-bottom: 10px; padding-bottom: 8px; }
    .form-grid { grid-template-columns: 1fr; gap: 8px; }
    .field input, .field select { padding: 10px; font-size: 14px; }
    .btn { padding: 10px 16px; font-size: 13px; }
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-card { padding: 10px; }
    .stat-value { font-size: 24px; }
    table { min-width: 400px; }
    td, th { padding: 7px 6px; font-size: 12px; }
    .modal { padding: 18px; }
    .toast { padding: 16px 20px; min-width: 200px; }
}

/* Pantallas grandes */
@media (min-width: 1200px) {
    .main { max-width: 960px; }
}

/* Preferencia de movimiento reducido */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
    }
}

    </style>
</head>
<body>

    <header class="header">
        <div class="logo">
            <div class="logo-icon">üéì</div>
            <div><h1>San Agust√≠n</h1><small>Asistencia Escolar</small></div>
        </div>
        <div class="header-right">
            <div class="chip chip-g" id="syncChip">‚è≥ Cargando...</div>
            <button class="btn-auth" id="authBtn" onclick="handleAuth()" style="display:none">üîë Conectar Google</button>
            <button class="btn-auth" id="logoutBtn" onclick="handleSignout()" style="display:none">Cerrar sesi√≥n</button>
        </div>
    </header>

    <nav class="nav" id="navBar">
        <button class="nav-btn active" data-panel="register">üìù Registrar</button>
        <button class="nav-btn" data-panel="scanner">üì∑ Escanear</button>
        <button class="nav-btn" data-panel="students">üë• Alumnos</button>
        <button class="nav-btn" data-panel="attendance">üìä Asistencia</button>
        <button class="nav-btn" data-panel="reports">üìã Reportes</button>
    </nav>

    <main class="main">

        <!-- PANEL: REGISTRAR -->
        <section id="panel-register" class="panel active">
            <div class="card">
                <div class="card-title">üìã Registrar Nuevo Alumno</div>
                <form id="regForm" onsubmit="doRegister(event)">
                    <div class="form-grid">
                        <div class="field full">
                            <label>Foto del alumno</label>
                            <div class="photo-row">
                                <div class="photo-circle" id="photoCircle" onclick="document.getElementById('photoFile').click()">üì∑</div>
                                <input type="file" id="photoFile" accept="image/*" style="display:none" onchange="loadPhoto(this)">
                                <small style="color:var(--txt3)">Toca para agregar foto (opcional)</small>
                            </div>
                        </div>
                        <div class="field">
                            <label>Nombre completo *</label>
                            <input type="text" id="inputName" required placeholder="Ej: Juan P√©rez L√≥pez">
                        </div>
                        <div class="field">
                            <label>DNI / Documento *</label>
                            <input type="text" id="inputDni" required placeholder="Ej: 12345678">
                        </div>
                        <div class="field">
                            <label>Grado *</label>
                            <select id="inputGrade" required>
                                <option value="">Seleccionar...</option>
                                <option>1¬∞ Primaria</option>
                                <option>2¬∞ Primaria</option>
                                <option>3¬∞ Primaria</option>
                                <option>4¬∞ Primaria</option>
                                <option>5¬∞ Primaria</option>
                                <option>6¬∞ Primaria</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Secci√≥n *</label>
                            <select id="inputSection" required>
                                <option value="">Seleccionar...</option>
                                <option>A</option>
                                <option>B</option>
                                <option>C</option>
                            </select>
                        </div>
                        <div class="field full">
                            <button type="submit" class="btn btn-blue btn-block">üì± Registrar y Generar C√≥digo QR</button>
                        </div>
                    </div>
                </form>
                <div class="qr-container" id="qrcode"></div>
                <p class="qr-status" id="qrStatus"></p>
                <div class="qr-actions" id="qrActions">
                    <button class="btn btn-blue btn-sm" onclick="downloadPDF()">üìÑ Descargar Carnet PDF</button>
                    <button class="btn btn-ghost btn-sm" onclick="downloadQRPng()">üñºÔ∏è Descargar QR</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üïê √öltimos Registros</div>
                <div id="recentList"></div>
            </div>
        </section>

        <!-- PANEL: ESC√ÅNER -->
        <section id="panel-scanner" class="panel">
            <div class="card">
                <div class="card-title">üì∑ Esc√°ner de Asistencia</div>
                <div class="scan-mode-selector">
                    <label class="mode-entrada">
                        <input type="radio" name="scanMode" value="ENTRADA" checked>
                        <span>üü¢ Entrada</span>
                    </label>
                    <label class="mode-salida">
                        <input type="radio" name="scanMode" value="SALIDA">
                        <span>üî¥ Salida</span>
                    </label>
                </div>
                <div id="reader"></div>
                <div id="scanFeedback"></div>
            </div>
            <div class="card">
                <div class="card-title">üìã Registros de Hoy</div>
                <div id="todayLog"></div>
            </div>
        </section>

        <!-- PANEL: ALUMNOS -->
        <section id="panel-students" class="panel">
            <input type="text" id="searchBox" class="search-box" placeholder="üîç Buscar alumno por nombre o DNI..." oninput="renderStudentsTable()">
            <div class="card">
                <div class="card-title">üë• Lista de Alumnos</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Alumno</th><th>DNI</th><th>Estado Hoy</th><th>QR</th></tr></thead>
                        <tbody id="studentsBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PANEL: ASISTENCIA -->
        <section id="panel-attendance" class="panel">
            <div class="stats-grid">
                <div class="stat-card blue"><div class="stat-label">Total Alumnos</div><div class="stat-value" id="statTotal">0</div></div>
                <div class="stat-card green"><div class="stat-label">Presentes Hoy</div><div class="stat-value" id="statPresent">0</div></div>
                <div class="stat-card red"><div class="stat-label">Ausentes Hoy</div><div class="stat-value" id="statAbsent">0</div></div>
                <div class="stat-card amber"><div class="stat-label">Salidas Registradas</div><div class="stat-value" id="statExits">0</div></div>
            </div>
            <div class="card">
                <div class="card-title">üìä Resumen del D√≠a</div>
                <div id="todayLog2"></div>
            </div>
        </section>

        <!-- PANEL: REPORTES -->
        <section id="panel-reports" class="panel">
            <div class="card">
                <div class="card-title">üìã Generar Reporte de Asistencia</div>
                <div class="report-filters">
                    <div class="field"><label>Fecha</label><input type="date" id="reportDate" onchange="renderReports()"></div>
                    <div class="field"><label>Grado</label><select id="reportGrade" onchange="renderReports()"><option value="">Todos</option></select></div>
                    <div class="field"><label>Secci√≥n</label>
                        <select id="reportSection" onchange="renderReports()">
                            <option value="">Todas</option><option>A</option><option>B</option><option>C</option>
                        </select>
                    </div>
                    <div class="field" style="justify-content:flex-end">
                        <label>&nbsp;</label>
                        <button class="btn btn-green btn-sm" onclick="downloadReport()">üìÑ Descargar PDF</button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom:14px">
                    <div class="stat-card blue"><div class="stat-label">Total</div><div class="stat-value" id="reportTotal">0</div></div>
                    <div class="stat-card green"><div class="stat-label">Presentes</div><div class="stat-value" id="reportPresent">0</div></div>
                    <div class="stat-card red"><div class="stat-label">Ausentes</div><div class="stat-value" id="reportAbsent">0</div></div>
                    <div class="stat-card amber"><div class="stat-label">Salidas</div><div class="stat-value" id="reportExits">0</div></div>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Alumno</th><th>Grado</th><th>Estado</th><th>Entrada</th><th>Salida</th></tr></thead>
                        <tbody id="reportBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üïê Horarios del D√≠a</div>
                <div id="scheduleToday"></div>
            </div>
        </section>

    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div class="overlay" id="overlay" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <h3 id="modalName"></h3>
            <p class="modal-sub" id="modalInfo"></p>
            <div class="qr-wrap" id="modalQR"></div>
            <div class="modal-btns">
                <button class="btn btn-blue btn-sm" onclick="downloadPDFFromModal()">üìÑ Carnet PDF</button>
                <button class="btn btn-red btn-sm" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
// ============================================================
// config.js ‚Äî Configuraci√≥n global del Sistema de Asistencia
// Colegio San Agust√≠n
// ============================================================

const CONFIG = {
    // --- Google API ---
    CLIENT_ID: '814005655098-8csk41qts3okv4b2fjnq7ls4qc2kq0vc.apps.googleusercontent.com',
    API_KEY: 'AIzaSyAOhGTjJXHhuUhqf1g2DPCla59xNzftb-Q',
    SHEET_ID: '1m0rv2gcMW3E8Yrh02PnwtHgZ3utj8XRPa9kYpwwm5oo',
    FOLDER_ID: '1ig8n3pthz8esYzmAsoibPUPz1MNVg88m',
    SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file',

    // --- Hojas de c√°lculo (nombres de pesta√±as) ---
    SHEETS: {
        ESTUDIANTES: 'Estudiantes',
        ASISTENCIA: 'Asistencia',
        CURSOS: 'Cursos',
        HORARIOS: 'Horarios'
    },

    // --- Rangos de lectura ---
    RANGES: {
        ESTUDIANTES: 'Estudiantes!A2:H',
        ASISTENCIA: 'Asistencia!A2:H',
        CURSOS: 'Cursos!A2:E',
        HORARIOS: 'Horarios!A2:F'
    },

    // --- Almacenamiento local ---
    STORAGE_KEY: 'san_agustin_v3',

    // --- Esc√°ner QR ---
    SCANNER: {
        FPS: 10,
        QR_BOX: 220,
        PAUSE_MS: 3000
    },

    // --- Foto de perfil ---
    PHOTO: {
        WIDTH: 200,
        HEIGHT: 200,
        QUALITY: 0.8
    },

    // --- Colegio ---
    SCHOOL: {
        NAME: 'Colegio San Agust√≠n',
        SHORT: 'San Agust√≠n',
        SUBTITLE: 'Sistema de Asistencia Escolar'
    },

    // --- Grados disponibles (por defecto, se complementan con Cursos de la hoja) ---
    GRADOS: [
        '1¬∞ Primaria', '2¬∞ Primaria', '3¬∞ Primaria',
        '4¬∞ Primaria', '5¬∞ Primaria', '6¬∞ Primaria'
    ],

    SECCIONES: ['A', 'B', 'C'],

    // --- Tipos de asistencia ---
    TIPOS: {
        ENTRADA: 'ENTRADA',
        SALIDA: 'SALIDA'
    }
};

// Estado global de la aplicaci√≥n
const APP = {
    tokenClient: null,
    gapiOk: false,
    gisOk: false,
    authed: false,
    qrScanner: null,
    currentPhoto: null,
    lastStudent: null,
    db: {
        students: [],
        attendance: [],
        courses: [],
        schedules: []
    }
};

    </script>

    <script>
// ============================================================
// script.js ‚Äî L√≥gica principal del Sistema de Asistencia
// Colegio San Agust√≠n
// ============================================================

// ‚îÄ‚îÄ‚îÄ GOOGLE AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onGapiLoad() {
    gapi.load('client', async () => {
        await gapi.client.init({
            apiKey: CONFIG.API_KEY,
            discoveryDocs: [
                'https://sheets.googleapis.com/$discovery/rest?version=v4',
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
            ]
        });
        APP.gapiOk = true;
        checkReady();
    });
}

function onGisLoad() {
    APP.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.CLIENT_ID,
        scope: CONFIG.SCOPES,
        callback: ''
    });
    APP.gisOk = true;
    checkReady();
}

function checkReady() {
    if (APP.gapiOk && APP.gisOk) {
        document.getElementById('authBtn').style.display = 'inline-flex';
        loadLocal();
        syncStatus('g', '‚è≥ Sin conexi√≥n');
    }
}

function handleAuth() {
    APP.tokenClient.callback = async (resp) => {
        if (resp.error) return;
        APP.authed = true;
        document.getElementById('authBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-flex';
        syncStatus('ok', '‚úÖ Conectado');
        await loadFromSheets();
    };
    const token = gapi.client.getToken();
    APP.tokenClient.requestAccessToken(token === null ? { prompt: 'consent' } : { prompt: '' });
}

function handleSignout() {
    const token = gapi.client.getToken();
    if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
    }
    APP.authed = false;
    document.getElementById('authBtn').style.display = 'inline-flex';
    document.getElementById('logoutBtn').style.display = 'none';
    syncStatus('g', '‚è≥ Desconectado');
}

// ‚îÄ‚îÄ‚îÄ ESTADO DE SINCRONIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncStatus(type, text) {
    const el = document.getElementById('syncChip');
    el.className = 'chip ' + (type === 'ok' ? 'chip-ok' : type === 'err' ? 'chip-err' : 'chip-g');
    el.textContent = text;
}

// ‚îÄ‚îÄ‚îÄ ALMACENAMIENTO LOCAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal() {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(APP.db));
}

function loadLocal() {
    const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (saved) {
        APP.db = JSON.parse(saved);
        refreshAll();
    }
}

// ‚îÄ‚îÄ‚îÄ CARGA DESDE GOOGLE SHEETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromSheets() {
    syncStatus('g', 'üîÑ Cargando...');
    try {
        // Estudiantes
        const resStudents = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEET_ID,
            range: CONFIG.RANGES.ESTUDIANTES
        });
        if (resStudents.result.values) {
            APP.db.students = resStudents.result.values.map(r => ({
                id: r[0], name: r[1], dni: r[2], grade: r[3],
                section: r[4], photoUrl: r[5] || '', qrUrl: r[6] || '',
                createdAt: r[7] || ''
            }));
        }

        // Asistencia
        const resAtt = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEET_ID,
            range: CONFIG.RANGES.ASISTENCIA
        });
        if (resAtt.result.values) {
            APP.db.attendance = resAtt.result.values.map(r => ({
                sid: r[0], name: r[1], dni: r[2], grade: r[3],
                section: r[4], date: r[5], time: r[6], type: r[7]
            }));
        }

        // Cursos
        try {
            const resCourses = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: CONFIG.SHEET_ID,
                range: CONFIG.RANGES.CURSOS
            });
            if (resCourses.result.values) {
                APP.db.courses = resCourses.result.values.map(r => ({
                    id: r[0], name: r[1], grade: r[2],
                    active: (r[3] || 'SI').toUpperCase() === 'SI',
                    description: r[4] || ''
                }));
            }
        } catch (e) { /* Pesta√±a puede no existir a√∫n */ }

        // Horarios
        try {
            const resSched = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: CONFIG.SHEET_ID,
                range: CONFIG.RANGES.HORARIOS
            });
            if (resSched.result.values) {
                APP.db.schedules = resSched.result.values.map(r => ({
                    courseId: r[0], courseName: r[1], day: r[2],
                    startTime: r[3], endTime: r[4], room: r[5] || ''
                }));
            }
        } catch (e) { /* Pesta√±a puede no existir a√∫n */ }

        saveLocal();
        refreshAll();
        syncStatus('ok', '‚úÖ Sincronizado');
    } catch (e) {
        console.error('Error al cargar:', e);
        syncStatus('err', '‚ùå Error de conexi√≥n');
    }
}

// ‚îÄ‚îÄ‚îÄ SUBIR ARCHIVOS A GOOGLE DRIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function uploadToDrive(fileName, base64Data, mimeType) {
    if (!APP.authed) return '';
    try {
        const rawBase64 = base64Data.split(',')[1];
        const metadata = JSON.stringify({
            name: fileName,
            parents: [CONFIG.FOLDER_ID],
            mimeType: mimeType
        });
        const body = `--boundary\r\nContent-Type: application/json\r\n\r\n${metadata}\r\n--boundary\r\nContent-Type: ${mimeType}\r\nContent-Transfer-Encoding: base64\r\n\r\n${rawBase64}\r\n--boundary--`;

        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                Authorization: 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'multipart/related; boundary=boundary'
            },
            body: body
        });
        const file = await res.json();
        return file.id ? `https://drive.google.com/uc?export=view&id=${file.id}` : '';
    } catch (e) {
        console.error('Error al subir archivo:', e);
        return '';
    }
}

// ‚îÄ‚îÄ‚îÄ UTILIDADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getToday() {
    return new Date().toISOString().split('T')[0];
}

function getTime() {
    return new Date().toLocaleTimeString('es-BO', { hour12: false });
}

function getTodayFormatted() {
    return new Date().toLocaleDateString('es-BO', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
}

function getAvatarColor(name) {
    const colors = ['#3b6cb4', '#2a8f6a', '#c68a1d', '#c9463d', '#7c3aed', '#0891b2', '#db2777'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
}

function getInitials(name) {
    return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
}

// ‚îÄ‚îÄ‚îÄ NOTIFICACI√ìN CENTRAL (TOAST) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(type, title, message) {
    const container = document.getElementById('toastContainer');
    const icons = { ok: '‚úÖ', bad: '‚ùå', warn: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || ''}</div>
        <h4>${title}</h4>
        <p>${message}</p>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) toast.remove();
    }, 3200);
}

// ‚îÄ‚îÄ‚îÄ FOTO DE PERFIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadPhoto(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = CONFIG.PHOTO.WIDTH;
            canvas.height = CONFIG.PHOTO.HEIGHT;
            canvas.getContext('2d').drawImage(img, 0, 0, CONFIG.PHOTO.WIDTH, CONFIG.PHOTO.HEIGHT);
            APP.currentPhoto = canvas.toDataURL('image/jpeg', CONFIG.PHOTO.QUALITY);
            document.getElementById('photoCircle').innerHTML =
                `<img src="${APP.currentPhoto}" alt="Foto">`;
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ‚îÄ‚îÄ‚îÄ REGISTRO DE ESTUDIANTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doRegister(event) {
    event.preventDefault();
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = '';

    const student = {
        id: 'SID' + Date.now(),
        name: document.getElementById('inputName').value.trim(),
        dni: document.getElementById('inputDni').value.trim(),
        grade: document.getElementById('inputGrade').value,
        section: document.getElementById('inputSection').value,
        photoUrl: '',
        qrUrl: '',
        createdAt: new Date().toISOString()
    };

    // Verificar DNI duplicado
    if (APP.db.students.find(s => s.dni === student.dni)) {
        showToast('bad', 'DNI duplicado', 'Este n√∫mero de documento ya est√° registrado.');
        return;
    }

    // Generar QR
    new QRCode(qrDiv, {
        text: JSON.stringify({ id: student.id }),
        width: 180,
        height: 180,
        correctLevel: QRCode.CorrectLevel.H
    });

    document.getElementById('qrActions').classList.add('visible');
    APP.lastStudent = { ...student, photo: APP.currentPhoto };

    await new Promise(r => setTimeout(r, 500));

    if (APP.authed) {
        document.getElementById('qrStatus').textContent = 'üîÑ Subiendo datos a Google...';
        student.photoUrl = APP.currentPhoto
            ? await uploadToDrive(`Foto_${student.dni}.jpg`, APP.currentPhoto, 'image/jpeg')
            : '';
        const qrCanvas = qrDiv.querySelector('canvas');
        student.qrUrl = await uploadToDrive(`QR_${student.dni}.png`, qrCanvas.toDataURL(), 'image/png');

        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEET_ID,
            range: CONFIG.SHEETS.ESTUDIANTES,
            valueInputOption: 'USER_ENTERED',
            resource: {
                values: [[
                    student.id, student.name, student.dni, student.grade,
                    student.section, student.photoUrl, student.qrUrl, student.createdAt
                ]]
            }
        });

        showToast('ok', 'Registrado', `${student.name} fue registrado y sincronizado con Google.`);
        document.getElementById('qrStatus').textContent = '‚úÖ Registrado y sincronizado';
    } else {
        showToast('info', 'Guardado localmente', `${student.name} fue registrado sin conexi√≥n a Google.`);
        document.getElementById('qrStatus').textContent = '‚úÖ Registrado localmente';
    }

    APP.db.students.push(student);
    saveLocal();
    refreshAll();

    // Limpiar formulario
    document.getElementById('regForm').reset();
    document.getElementById('photoCircle').innerHTML = 'üì∑';
    APP.currentPhoto = null;
}

// ‚îÄ‚îÄ‚îÄ ESC√ÅNER QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function onScanSuccess(decodedText) {
    if (APP.qrScanner.isPaused) return;
    APP.qrScanner.pause(true);

    try {
        const data = JSON.parse(decodedText);
        const student = APP.db.students.find(s => s.id === data.id);

        if (!student) {
            showScanFeedback('bad', '‚ùå No registrado', 'Este alumno no existe en la base de datos.');
            showToast('bad', 'No registrado', 'C√≥digo QR no encontrado en el sistema.');
        } else {
            const mode = document.querySelector('input[name="scanMode"]:checked').value;
            const today = getToday();
            const alreadyMarked = APP.db.attendance.find(
                a => a.sid === student.id && a.date === today && a.type === mode
            );

            if (alreadyMarked) {
                showScanFeedback('warn', `‚ö†Ô∏è ${student.name}`,
                    `Ya registr√≥ su ${mode.toLowerCase()} hoy a las ${alreadyMarked.time}`);
                showToast('warn', 'Ya registrado', `${student.name} ya tiene ${mode.toLowerCase()} hoy.`);
            } else {
                const record = {
                    sid: student.id, name: student.name, dni: student.dni,
                    grade: student.grade, section: student.section,
                    date: today, time: getTime(), type: mode
                };
                APP.db.attendance.push(record);
                saveLocal();

                if (APP.authed) {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: CONFIG.SHEETS.ASISTENCIA,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [[record.sid, record.name, record.dni, record.grade,
                                record.section, record.date, record.time, record.type]]
                        }
                    });
                }

                const modeLabel = mode === 'ENTRADA' ? 'üü¢ Entrada' : 'üî¥ Salida';
                showScanFeedback('ok', `‚úÖ ${student.name}`, `${modeLabel} registrada: ${record.time}`);
                showToast('ok', student.name, `${modeLabel} a las ${record.time}`);
                refreshAll();
            }
        }
    } catch (e) {
        showScanFeedback('bad', '‚ùå Error de lectura', 'El c√≥digo QR no es v√°lido para este sistema.');
        showToast('bad', 'QR inv√°lido', 'No se pudo leer el c√≥digo.');
    }

    setTimeout(() => { APP.qrScanner.resume(); }, CONFIG.SCANNER.PAUSE_MS);
}

function showScanFeedback(type, title, msg) {
    document.getElementById('scanFeedback').innerHTML =
        `<div class="scan-feedback ${type}"><h4>${title}</h4><p>${msg}</p></div>`;
}

// ‚îÄ‚îÄ‚îÄ RENDERIZADO DE INTERFAZ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function refreshAll() {
    renderRecentRegistrations();
    renderStudentsTable();
    renderAttendanceStats();
    renderTodayLog();
    renderReports();
    populateCourseFilters();
}

function renderRecentRegistrations() {
    const list = [...APP.db.students].reverse().slice(0, 5);
    const container = document.getElementById('recentList');
    if (!list.length) {
        container.innerHTML = '<p class="empty-msg">No hay registros todav√≠a</p>';
        return;
    }
    container.innerHTML = list.map(s => `
        <div class="list-row">
            <div>
                <b>${s.name}</b><br>
                <small style="color:var(--txt2)">${s.grade} ${s.section}</small>
            </div>
            <button class="btn btn-blue btn-sm" onclick="openQRModal('${s.id}')">üì± QR</button>
        </div>
    `).join('');
}

function renderStudentsTable() {
    const query = document.getElementById('searchBox').value.toLowerCase();
    const today = getToday();
    const filtered = APP.db.students.filter(
        s => s.name.toLowerCase().includes(query) || s.dni.includes(query)
    );
    const tbody = document.getElementById('studentsBody');
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">No se encontraron alumnos</td></tr>';
        return;
    }
    tbody.innerHTML = filtered.map(s => {
        const hasEntry = APP.db.attendance.find(
            a => a.sid === s.id && a.date === today && a.type === CONFIG.TIPOS.ENTRADA
        );
        const color = getAvatarColor(s.name);
        return `<tr>
            <td>
                <div class="cell-name">
                    <div class="avatar" style="background:${color}">${getInitials(s.name)}</div>
                    <div><b>${s.name}</b><br><small style="color:var(--txt3)">${s.grade} ${s.section}</small></div>
                </div>
            </td>
            <td>${s.dni}</td>
            <td><span class="tag ${hasEntry ? 'tag-ok' : 'tag-no'}">${hasEntry ? 'Presente' : 'Ausente'}</span></td>
            <td><button class="btn btn-blue btn-sm" onclick="openQRModal('${s.id}')">üì±</button></td>
        </tr>`;
    }).join('');
}

function renderTodayLog() {
    const today = getToday();
    const log = APP.db.attendance.filter(a => a.date === today).reverse();
    const container = document.getElementById('todayLog');
    if (!log.length) {
        container.innerHTML = '<p class="empty-msg">Esperando lecturas de QR...</p>';
        return;
    }
    container.innerHTML = log.map(a => {
        const isEntry = a.type === CONFIG.TIPOS.ENTRADA;
        return `<div class="list-row">
            <div>
                <b>${a.name}</b><br>
                <small style="color:var(--txt2)">${a.grade} ${a.section}</small>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
                <span class="tag ${isEntry ? 'tag-ok' : 'tag-warn'}">${isEntry ? 'üü¢ Entrada' : 'üî¥ Salida'}</span>
                <span class="list-time">${a.time}</span>
            </div>
        </div>`;
    }).join('');
}

function renderAttendanceStats() {
    const today = getToday();
    const total = APP.db.students.length;
    const present = APP.db.attendance.filter(
        a => a.date === today && a.type === CONFIG.TIPOS.ENTRADA
    ).length;
    const absent = total - present;
    const exits = APP.db.attendance.filter(
        a => a.date === today && a.type === CONFIG.TIPOS.SALIDA
    ).length;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statPresent').textContent = present;
    document.getElementById('statAbsent').textContent = absent;
    document.getElementById('statExits').textContent = exits;
}

// ‚îÄ‚îÄ‚îÄ REPORTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateCourseFilters() {
    const gradeFilter = document.getElementById('reportGrade');
    if (!gradeFilter) return;

    // Obtener grados √∫nicos de estudiantes
    const grades = [...new Set(APP.db.students.map(s => s.grade))].sort();
    const current = gradeFilter.value;
    gradeFilter.innerHTML = '<option value="">Todos los grados</option>' +
        grades.map(g => `<option value="${g}" ${g === current ? 'selected' : ''}>${g}</option>`).join('');
}

function renderReports() {
    const dateFilter = document.getElementById('reportDate')?.value || getToday();
    const gradeFilter = document.getElementById('reportGrade')?.value || '';
    const sectionFilter = document.getElementById('reportSection')?.value || '';

    // Filtrar asistencia
    let filtered = APP.db.attendance.filter(a => a.date === dateFilter);
    if (gradeFilter) filtered = filtered.filter(a => a.grade === gradeFilter);
    if (sectionFilter) filtered = filtered.filter(a => a.section === sectionFilter);

    // Filtrar estudiantes para calcular ausentes
    let filteredStudents = [...APP.db.students];
    if (gradeFilter) filteredStudents = filteredStudents.filter(s => s.grade === gradeFilter);
    if (sectionFilter) filteredStudents = filteredStudents.filter(s => s.section === sectionFilter);

    const entries = filtered.filter(a => a.type === CONFIG.TIPOS.ENTRADA);
    const exits = filtered.filter(a => a.type === CONFIG.TIPOS.SALIDA);
    const presentIds = new Set(entries.map(a => a.sid));
    const absentStudents = filteredStudents.filter(s => !presentIds.has(s.id));

    // Resumen
    document.getElementById('reportTotal').textContent = filteredStudents.length;
    document.getElementById('reportPresent').textContent = entries.length;
    document.getElementById('reportAbsent').textContent = absentStudents.length;
    document.getElementById('reportExits').textContent = exits.length;

    // Tabla de reporte
    const reportBody = document.getElementById('reportBody');
    if (!entries.length && !absentStudents.length) {
        reportBody.innerHTML = '<tr><td colspan="5" class="empty-msg">Sin datos para este filtro</td></tr>';
        return;
    }

    let rows = '';
    // Presentes
    entries.forEach(a => {
        rows += `<tr>
            <td><b>${a.name}</b></td>
            <td>${a.grade} ${a.section}</td>
            <td><span class="tag tag-ok">Presente</span></td>
            <td>${a.time}</td>
            <td>${exits.find(x => x.sid === a.sid)?.time || '‚Äî'}</td>
        </tr>`;
    });
    // Ausentes
    absentStudents.forEach(s => {
        rows += `<tr>
            <td><b>${s.name}</b></td>
            <td>${s.grade} ${s.section}</td>
            <td><span class="tag tag-no">Ausente</span></td>
            <td>‚Äî</td><td>‚Äî</td>
        </tr>`;
    });

    reportBody.innerHTML = rows;

    // Horarios del d√≠a
    renderScheduleForDay(dateFilter);
}

function renderScheduleForDay(dateStr) {
    const container = document.getElementById('scheduleToday');
    if (!container) return;

    const dayNames = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
    const dayOfWeek = dayNames[new Date(dateStr + 'T12:00:00').getDay()];

    const todaySchedules = APP.db.schedules.filter(
        s => s.day.toLowerCase() === dayOfWeek
    );

    if (!todaySchedules.length) {
        container.innerHTML = '<p class="empty-msg">No hay horarios cargados para este d√≠a</p>';
        return;
    }

    container.innerHTML = todaySchedules.map(s => `
        <div class="list-row">
            <div>
                <b>${s.courseName}</b><br>
                <small style="color:var(--txt2)">${s.room ? 'Aula: ' + s.room : ''}</small>
            </div>
            <span class="list-time">${s.startTime} - ${s.endTime}</span>
        </div>
    `).join('');
}

function downloadReport() {
    const { jsPDF } = window.jspdf;
    const dateFilter = document.getElementById('reportDate')?.value || getToday();
    const gradeFilter = document.getElementById('reportGrade')?.value || '';
    const sectionFilter = document.getElementById('reportSection')?.value || '';

    let filtered = APP.db.attendance.filter(a => a.date === dateFilter);
    if (gradeFilter) filtered = filtered.filter(a => a.grade === gradeFilter);
    if (sectionFilter) filtered = filtered.filter(a => a.section === sectionFilter);

    let filteredStudents = [...APP.db.students];
    if (gradeFilter) filteredStudents = filteredStudents.filter(s => s.grade === gradeFilter);
    if (sectionFilter) filteredStudents = filteredStudents.filter(s => s.section === sectionFilter);

    const entries = filtered.filter(a => a.type === CONFIG.TIPOS.ENTRADA);
    const exits = filtered.filter(a => a.type === CONFIG.TIPOS.SALIDA);
    const presentIds = new Set(entries.map(a => a.sid));
    const absentStudents = filteredStudents.filter(s => !presentIds.has(s.id));

    const doc = new jsPDF('p', 'mm', 'a4');
    const pageW = doc.internal.pageSize.getWidth();

    // Encabezado
    doc.setFillColor(27, 46, 74);
    doc.rect(0, 0, pageW, 25, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.text(CONFIG.SCHOOL.NAME.toUpperCase(), pageW / 2, 11, { align: 'center' });
    doc.setFontSize(10);
    doc.text('REPORTE DE ASISTENCIA', pageW / 2, 18, { align: 'center' });

    doc.setTextColor(0, 0, 0);
    let y = 35;

    // Info
    doc.setFontSize(11);
    doc.text(`Fecha: ${dateFilter}`, 14, y);
    if (gradeFilter) doc.text(`Grado: ${gradeFilter}`, 14, y + 6);
    if (sectionFilter) doc.text(`Secci√≥n: ${sectionFilter}`, 80, y + 6);
    y += gradeFilter ? 16 : 10;

    // Resumen
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text(`Total: ${filteredStudents.length}  |  Presentes: ${entries.length}  |  Ausentes: ${absentStudents.length}`, 14, y);
    doc.setFont(undefined, 'normal');
    y += 10;

    // Tabla
    doc.setFillColor(240, 233, 220);
    doc.rect(14, y, pageW - 28, 7, 'F');
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text('ALUMNO', 16, y + 5);
    doc.text('GRADO', 75, y + 5);
    doc.text('ESTADO', 105, y + 5);
    doc.text('ENTRADA', 135, y + 5);
    doc.text('SALIDA', 165, y + 5);
    doc.setFont(undefined, 'normal');
    y += 10;

    const addRow = (name, grade, status, entryTime, exitTime) => {
        if (y > 275) { doc.addPage(); y = 20; }
        doc.setFontSize(8);
        doc.text(name.substring(0, 30), 16, y);
        doc.text(grade, 75, y);
        doc.text(status, 105, y);
        doc.text(entryTime, 135, y);
        doc.text(exitTime, 165, y);
        y += 6;
    };

    entries.forEach(a => {
        const exitTime = exits.find(x => x.sid === a.sid)?.time || '‚Äî';
        addRow(a.name, `${a.grade} ${a.section}`, 'PRESENTE', a.time, exitTime);
    });

    absentStudents.forEach(s => {
        addRow(s.name, `${s.grade} ${s.section}`, 'AUSENTE', '‚Äî', '‚Äî');
    });

    // Pie
    y += 8;
    doc.setFontSize(7);
    doc.setTextColor(150);
    doc.text(`Generado: ${new Date().toLocaleString('es-BO')}  |  ${CONFIG.SCHOOL.NAME}`, 14, y);

    const fileName = `Reporte_${dateFilter}${gradeFilter ? '_' + gradeFilter : ''}${sectionFilter ? '_' + sectionFilter : ''}.pdf`;
    doc.save(fileName);
    showToast('ok', 'Reporte generado', `Se descarg√≥ ${fileName}`);
}

// ‚îÄ‚îÄ‚îÄ MODAL QR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openQRModal(studentId) {
    const student = APP.db.students.find(s => s.id === studentId);
    if (!student) return;
    APP.lastStudent = student;
    document.getElementById('modalName').textContent = student.name;
    document.getElementById('modalInfo').textContent = `${student.grade} ${student.section} ‚Äî DNI: ${student.dni}`;
    const qrWrap = document.getElementById('modalQR');
    qrWrap.innerHTML = '';
    new QRCode(qrWrap, { text: JSON.stringify({ id: student.id }), width: 160, height: 160 });
    document.getElementById('overlay').classList.add('open');
}

function closeModal() {
    document.getElementById('overlay').classList.remove('open');
}

// ‚îÄ‚îÄ‚îÄ DESCARGAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadQRPng() {
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas || !APP.lastStudent) return;
    const link = document.createElement('a');
    link.download = `QR_${APP.lastStudent.dni}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function downloadPDF() {
    if (!APP.lastStudent) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', [90, 60]);

    doc.setFillColor(27, 46, 74);
    doc.rect(0, 0, 90, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text(CONFIG.SCHOOL.NAME.toUpperCase(), 45, 10, { align: 'center' });

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.text(APP.lastStudent.name.toUpperCase(), 10, 24);
    doc.setFontSize(7);
    doc.text('DNI: ' + APP.lastStudent.dni, 10, 30);
    doc.text('Grado: ' + APP.lastStudent.grade, 10, 36);
    doc.text('Secci√≥n: ' + APP.lastStudent.section, 10, 42);

    const canvas = document.querySelector('#qrcode canvas') || document.querySelector('#modalQR canvas');
    if (canvas) doc.addImage(canvas.toDataURL(), 'PNG', 55, 18, 30, 30);

    doc.save(`Carnet_${APP.lastStudent.dni}.pdf`);
    showToast('ok', 'Carnet generado', `PDF descargado para ${APP.lastStudent.name}`);
}

function downloadPDFFromModal() {
    if (!APP.lastStudent) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', [90, 60]);

    doc.setFillColor(27, 46, 74);
    doc.rect(0, 0, 90, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text(CONFIG.SCHOOL.NAME.toUpperCase(), 45, 10, { align: 'center' });

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(9);
    doc.text(APP.lastStudent.name.toUpperCase(), 10, 24);
    doc.setFontSize(7);
    doc.text('DNI: ' + APP.lastStudent.dni, 10, 30);
    doc.text('Grado: ' + APP.lastStudent.grade, 10, 36);
    doc.text('Secci√≥n: ' + (APP.lastStudent.section || ''), 10, 42);

    const canvas = document.querySelector('#modalQR canvas');
    if (canvas) doc.addImage(canvas.toDataURL(), 'PNG', 55, 18, 30, 30);

    doc.save(`Carnet_${APP.lastStudent.dni}.pdf`);
}

// ‚îÄ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initNavigation() {
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Desactivar todos
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            // Activar seleccionado
            btn.classList.add('active');
            const panelId = 'panel-' + btn.dataset.panel;
            document.getElementById(panelId).classList.add('active');

            // Manejar c√°mara
            if (btn.dataset.panel !== 'scanner' && APP.qrScanner) {
                APP.qrScanner.clear();
                APP.qrScanner = null;
            }

            if (btn.dataset.panel === 'scanner') {
                APP.qrScanner = new Html5QrcodeScanner('reader', {
                    fps: CONFIG.SCANNER.FPS,
                    qrbox: CONFIG.SCANNER.QR_BOX
                });
                APP.qrScanner.render(onScanSuccess);
            }

            // Actualizar reportes si se abre esa pesta√±a
            if (btn.dataset.panel === 'reports') {
                renderReports();
            }
        });
    });
}

// ‚îÄ‚îÄ‚îÄ MODO ESCANEO (estilos din√°micos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initScanModeToggle() {
    document.querySelectorAll('input[name="scanMode"]').forEach(radio => {
        radio.addEventListener('change', () => updateScanModeStyles());
    });
    updateScanModeStyles();
}

function updateScanModeStyles() {
    const selected = document.querySelector('input[name="scanMode"]:checked')?.value;
    document.querySelectorAll('.scan-mode-selector label').forEach(label => {
        label.classList.remove('mode-active-entrada', 'mode-active-salida');
    });
    if (selected === 'ENTRADA') {
        document.querySelector('.mode-entrada')?.classList.add('mode-active-entrada');
    } else {
        document.querySelector('.mode-salida')?.classList.add('mode-active-salida');
    }
}

// ‚îÄ‚îÄ‚îÄ INICIALIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
    initNavigation();
    initScanModeToggle();

    // Fecha por defecto en reportes
    const reportDate = document.getElementById('reportDate');
    if (reportDate) reportDate.value = getToday();
});

    </script>

</body>
</html>
